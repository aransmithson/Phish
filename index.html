<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üêü Phishy</title>
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  :root {
    --ink:    #0e1a0f;
    --panel:  #162418;
    --rim:    #2a4a2e;
    --gold:   #f0c040;
    --gold2:  #c8900a;
    --lime:   #6ddb4a;
    --cyan:   #38d9c0;
    --red:    #f04545;
    --orange: #f07830;
    --txt:    #dff5d8;
    --muted:  #7aaa7a;
    --hdr:    52px;
    --ftr:    0px;
  }
  html, body {
    width:100%; height:100%; overflow:hidden;
    background: var(--ink);
    font-family: 'Nunito', sans-serif;
    color: var(--txt);
    user-select:none; -webkit-user-select:none;
  }
  #header {
    position:fixed; top:0; left:0; right:0;
    height: var(--hdr);
    background: var(--panel);
    border-bottom: 3px solid var(--rim);
    display:flex; align-items:center; justify-content:space-between;
    padding:0 10px 0 14px;
    z-index:100;
  }
  .logo { display:flex; align-items:center; gap:6px; text-decoration:none; }
  .logo-fish { font-size:1.7rem; filter: drop-shadow(0 0 6px rgba(56,217,192,0.7)); animation: fishSwim 3s ease-in-out infinite; }
  @keyframes fishSwim { 0%,100%{transform:translateY(0) rotate(-4deg)}50%{transform:translateY(-3px) rotate(4deg)} }
  .logo-text { font-family:'Black Han Sans',sans-serif; font-size:1.55rem; letter-spacing:3px; line-height:1;
    background:linear-gradient(135deg,var(--gold) 0%,var(--lime) 100%);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    filter:drop-shadow(0 2px 8px rgba(240,192,64,0.4)); }
  .hdr-right { display:flex; align-items:center; gap:6px; }
  .coin-badge { display:flex; align-items:center; gap:5px; background:linear-gradient(135deg,#2a1a00,#3a2800);
    border:2px solid var(--gold2); border-radius:20px; padding:4px 12px 4px 8px; font-weight:900; font-size:0.95rem;
    color:var(--gold); box-shadow:0 0 12px rgba(240,192,64,0.25),inset 0 1px 0 rgba(255,255,255,0.08); }
  .ic-btn { width:36px; height:36px; background:var(--ink); border:2px solid var(--rim); border-radius:10px;
    display:flex; align-items:center; justify-content:center; font-size:1rem; cursor:pointer;
    transition:border-color 0.15s,background 0.15s,transform 0.1s; flex-shrink:0; }
  .ic-btn:hover { border-color:var(--lime); background:#1e321e; }
  .ic-btn:active { transform:scale(0.9); }
  .ic-btn.on { border-color:var(--lime); background:#1a3a1a; box-shadow:0 0 10px rgba(109,219,74,0.4); }
  #viewport { position:fixed; top:var(--hdr); bottom:var(--ftr); left:0; right:0; overflow:hidden; cursor:crosshair; }
  #gameCanvas { position:absolute; top:0; left:0; transform-origin:0 0; }

  /* ‚îÄ‚îÄ FLOATING MONEY BADGE ‚îÄ‚îÄ */
  #money-float { position:fixed; top:calc(var(--hdr) + 10px); right:12px;
    background:linear-gradient(135deg,#2a1a00,#3a2800); border:2px solid var(--gold2); border-radius:22px;
    padding:6px 14px 6px 10px; font-weight:900; font-size:1rem; color:var(--gold);
    display:flex; align-items:center; gap:5px; z-index:97; pointer-events:none;
    box-shadow:0 4px 16px rgba(240,192,64,0.3),0 2px 0 rgba(0,0,0,0.4); }

  /* ‚îÄ‚îÄ BAIT BOX POPUP ‚îÄ‚îÄ */
  #bait-box { position:fixed; bottom:20px; left:80px; background:var(--panel); border:3px solid var(--rim);
    border-radius:18px; padding:14px; z-index:98; min-width:220px; box-shadow:0 -4px 30px rgba(0,0,0,0.6);
    display:none; animation:bbSlide 0.2s cubic-bezier(0.34,1.3,0.64,1); }
  #bait-box.open { display:block; }
  @keyframes bbSlide { from{opacity:0;transform:translateY(12px) scale(0.95)} to{opacity:1;transform:translateY(0) scale(1)} }
  .bb-title { font-family:'Black Han Sans',sans-serif; font-size:0.85rem; letter-spacing:2px; color:var(--gold); margin-bottom:10px; }
  .bb-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:7px; margin-bottom:10px; }
  .bb-bait { display:flex; flex-direction:column; align-items:center; gap:2px; padding:8px 6px;
    background:var(--ink); border:2px solid var(--rim); border-radius:12px; cursor:pointer; transition:all 0.15s; }
  .bb-bait:hover { border-color:#4a7a4a; background:#182818; transform:translateY(-2px); }
  .bb-bait:active { transform:scale(0.92); }
  .bb-bait.sel { border-color:var(--lime); background:#132013; box-shadow:0 0 12px rgba(109,219,74,0.4); }
  .bb-bait.locked { opacity:0.45; cursor:not-allowed; }
  .bb-bait-icon { font-size:1.5rem; line-height:1; }
  .bb-bait-name { font-size:0.62rem; font-weight:900; text-transform:uppercase; letter-spacing:0.5px; color:var(--muted); }
  .bb-bait.sel .bb-bait-name { color:var(--lime); }
  .bb-bait-qty { font-size:0.58rem; font-weight:900; color:var(--gold); }
  .bb-sep { height:2px; background:var(--rim); border-radius:1px; margin-bottom:10px; }
  .bb-depth-lbl { font-size:0.6rem; font-weight:900; text-transform:uppercase; letter-spacing:2px; color:var(--muted); margin-bottom:6px; }
  .bb-depth-row { display:flex; gap:6px; }
  .bb-depth-btn { flex:1; padding:7px 4px; background:var(--ink); border:2px solid var(--rim); border-radius:10px;
    cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:2px;
    font-size:0.6rem; font-weight:900; text-transform:uppercase; letter-spacing:0.5px; color:var(--muted); transition:all 0.15s; }
  .bb-depth-btn .dbi { font-size:1rem; }
  .bb-depth-btn:hover { border-color:#4a7a4a; }
  .bb-depth-btn.sel { border-color:var(--cyan); background:#0e2428; color:var(--cyan); box-shadow:0 0 10px rgba(56,217,192,0.3); }
  .bb-step-indicator { display:flex; gap:6px; margin-bottom:10px; }
  .bb-step { flex:1; text-align:center; padding:5px 4px; border-radius:8px; font-size:0.6rem; font-weight:900; text-transform:uppercase; letter-spacing:1px; border:2px solid var(--rim); color:var(--muted); background:var(--ink); }
  .bb-step.active { border-color:var(--lime); color:var(--lime); background:#0e2010; }
  .bb-step.done { border-color:var(--rim); color:var(--muted); background:rgba(109,219,74,0.07); }
  .bb-confirm-btn { width:100%; padding:10px; background:linear-gradient(160deg,#6ddb4a,#2a7a18); border:none;
    border-radius:12px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.9rem;
    color:#061206; cursor:pointer; margin-top:8px; box-shadow:0 3px 0 #145010;
    transition:filter 0.1s,transform 0.1s; display:none; }
  .bb-confirm-btn.show { display:block; }
  .bb-confirm-btn:hover { filter:brightness(1.1); transform:translateY(-1px); }
  .bb-confirm-btn:active { transform:translateY(1px); }

  /* ‚îÄ‚îÄ DISTANCE HUD (fish fight) ‚îÄ‚îÄ */
  #dist-hud {
    position:fixed; bottom:24px; right:16px;
    display:none; flex-direction:column; align-items:center; gap:5px;
    background:rgba(14,26,15,0.92); border:2px solid var(--rim); border-radius:16px; padding:10px 18px;
    z-index:97; min-width:160px; box-shadow:0 4px 20px rgba(0,0,0,0.5); pointer-events:none;
  }
  #dist-hud.show { display:flex; }
  .dh-label { font-size:0.62rem; font-weight:900; text-transform:uppercase; letter-spacing:2px; color:var(--muted); }
  .dh-dist { font-family:'Black Han Sans',sans-serif; font-size:1.8rem; letter-spacing:2px; color:var(--gold); line-height:1; }
  .dh-bar-track { width:130px; height:8px; background:var(--ink); border:1px solid var(--rim); border-radius:4px; overflow:hidden; }
  .dh-bar-fill { height:100%; border-radius:4px; background:linear-gradient(to right,var(--lime),var(--gold)); transition:width 0.3s; }
  .dh-sublabel { font-size:0.58rem; font-weight:700; color:var(--muted); }

  /* ‚îÄ‚îÄ FLOATING SIDE BUTTONS ‚îÄ‚îÄ */
  #side-btns { position:fixed; left:10px; top:50%; transform:translateY(-50%); display:none; flex-direction:column; gap:8px; z-index:99; }
  #side-btns.show { display:flex; }
  .side-fab { width:62px; height:62px; border-radius:16px; border:none; cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.58rem; text-transform:uppercase; letter-spacing:0.8px; transition:transform 0.12s,filter 0.12s; position:relative; }
  .side-fab::after { content:''; position:absolute; bottom:0; left:4px; right:4px; height:3px; border-radius:0 0 12px 12px; background:rgba(0,0,0,0.3); }
  .side-fab:hover { transform:translateX(4px) scale(1.06); filter:brightness(1.12); }
  .side-fab:active { transform:scale(0.91); }
  .side-fab .fab-icon { font-size:1.55rem; line-height:1; }
  .fab-cast { background:linear-gradient(160deg,#6ddb4a,#2a7a18); color:#061206; box-shadow:3px 4px 0 #145010,4px 6px 18px rgba(109,219,74,0.4); }
  .fab-reel { background:linear-gradient(160deg,#3ab8f5,#1670c0); color:#fff; box-shadow:3px 4px 0 #0d4a8a,4px 6px 18px rgba(58,184,245,0.35); }
  .fab-reel.reeling { background:linear-gradient(160deg,#4fc92e,#2e8a18); color:#fff; box-shadow:3px 4px 0 #1a5a0a,4px 6px 18px rgba(78,201,46,0.4); animation:reelActive 0.3s infinite alternate; }
  .fab-reel.danger { background:linear-gradient(160deg,#f55050,#b01818); color:#fff; box-shadow:3px 4px 0 #6a0a0a,4px 6px 18px rgba(245,80,80,0.4); animation:reelPulse 0.5s infinite alternate; }
  .fab-groundbait { background:linear-gradient(160deg,#b07030,#6a3a10); color:#fff5e0; box-shadow:3px 4px 0 #3a1a04,4px 6px 18px rgba(160,100,40,0.35); }
  .fab-bait-box { background:linear-gradient(160deg,#c8a030,#6a4800); color:#fff5d0; box-shadow:3px 4px 0 #3a2400,4px 6px 18px rgba(200,160,48,0.35); }
  .fab-shop { background:linear-gradient(160deg,#8855cc,#4422aa); color:#f0e0ff; box-shadow:3px 4px 0 #220066,4px 6px 18px rgba(140,80,220,0.4); }
  .fab-sep { width:40px; height:2px; background:var(--rim); border-radius:1px; margin:2px auto; }
  @keyframes reelPulse { from{box-shadow:3px 4px 0 #6a0a0a,4px 6px 18px rgba(245,80,80,0.35)} to{box-shadow:3px 4px 0 #6a0a0a,4px 6px 28px rgba(245,80,80,0.7)} }
  @keyframes reelActive { from{transform:translateX(4px) scale(1.06)} to{transform:translateX(6px) scale(1.1)} }

  /* ‚îÄ‚îÄ FIGHT HUD (unified panel replacing old tension-hud) ‚îÄ‚îÄ */
  #tension-hud {
    display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    width:min(380px,92vw);
    background:linear-gradient(160deg,rgba(6,14,10,0.96) 0%,rgba(10,20,14,0.96) 100%);
    border:2px solid rgba(56,217,192,0.2);
    border-radius:20px; padding:14px 16px 16px; z-index:98; pointer-events:none;
    box-shadow:0 8px 40px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.04);
    backdrop-filter:blur(8px);
    transition:border-color 0.2s, box-shadow 0.2s;
  }
  #tension-hud.show { display:block; }
  #tension-hud.danger {
    border-color:rgba(240,69,69,0.8);
    box-shadow:0 8px 40px rgba(0,0,0,0.7), 0 0 0 1px rgba(240,69,69,0.2), 0 0 30px rgba(240,69,69,0.3);
    animation:tensionPulse 0.35s infinite alternate;
  }
  @keyframes tensionPulse {
    from{box-shadow:0 8px 40px rgba(0,0,0,0.7),0 0 0 1px rgba(240,69,69,0.2),0 0 20px rgba(240,69,69,0.2)}
    to{box-shadow:0 8px 40px rgba(0,0,0,0.7),0 0 0 2px rgba(240,69,69,0.5),0 0 40px rgba(240,69,69,0.5)}
  }

  /* Fish name & phase row */
  #fight-fish-row {
    display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;
  }
  #fight-fish-name {
    font-family:'Black Han Sans',sans-serif; font-size:1.05rem; letter-spacing:2px;
    background:linear-gradient(135deg,#f0c040,#6ddb4a);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  }
  #fight-phase-badge {
    font-size:0.6rem; font-weight:900; text-transform:uppercase; letter-spacing:1.5px;
    padding:3px 9px; border-radius:20px; border:1.5px solid;
    transition:all 0.4s;
  }
  #fight-phase-badge.fresh  { color:#6ddb4a; border-color:#6ddb4a; background:rgba(109,219,74,0.1); }
  #fight-phase-badge.tiring { color:#f0c040; border-color:#f0c040; background:rgba(240,192,64,0.1); }
  #fight-phase-badge.exhausted { color:#f04545; border-color:#f04545; background:rgba(240,69,69,0.12);
    animation:badgePulse 0.6s infinite alternate; }
  @keyframes badgePulse { from{opacity:0.7} to{opacity:1} }

  /* Status banner */
  #fight-status-banner {
    text-align:center; font-size:0.72rem; font-weight:900; letter-spacing:1px;
    padding:7px 10px; border-radius:10px; margin-bottom:10px;
    transition:background 0.3s, color 0.3s;
  }
  #fight-status-banner.running {
    background:rgba(240,69,69,0.18); color:#ff7070; border:1px solid rgba(240,69,69,0.3);
  }
  #fight-status-banner.reeling {
    background:rgba(58,184,245,0.15); color:#6dd4f8; border:1px solid rgba(58,184,245,0.25);
  }
  #fight-status-banner.resting {
    background:rgba(109,219,74,0.12); color:#8deb6a; border:1px solid rgba(109,219,74,0.2);
  }
  #fight-status-banner.danger-run {
    background:rgba(240,69,69,0.28); color:#ff4040;
    border:1px solid rgba(240,69,69,0.5);
    animation:statusFlash 0.4s infinite alternate;
  }
  @keyframes statusFlash { from{background:rgba(240,69,69,0.2)} to{background:rgba(240,69,69,0.4)} }

  /* Dual bars container */
  .fight-bars { display:flex; flex-direction:column; gap:8px; margin-bottom:10px; }

  /* Tension bar */
  .fight-bar-row { display:flex; align-items:center; gap:8px; }
  .fight-bar-label {
    font-size:0.56rem; font-weight:900; text-transform:uppercase; letter-spacing:1.5px;
    color:rgba(255,255,255,0.45); width:46px; flex-shrink:0;
  }
  .fight-bar-outer {
    flex:1; height:20px; background:rgba(255,255,255,0.06);
    border-radius:6px; overflow:hidden; position:relative;
    border:1px solid rgba(255,255,255,0.07);
  }
  #tension-fill {
    height:100%; width:0%; border-radius:6px;
    background:linear-gradient(to right,#3ddb3d 0%,#f0c040 45%,#f07830 75%,#f04545 100%);
    background-size:380px 100%;
    transition:width 0.1s ease-out;
    position:relative;
  }
  #tension-fill::after {
    content:attr(data-pct); position:absolute; right:7px; top:50%;
    transform:translateY(-50%); font-size:0.72rem; font-weight:900; color:rgba(255,255,255,0.9);
    white-space:nowrap; text-shadow:0 1px 3px rgba(0,0,0,0.8);
  }

  /* Stamina bar */
  #stamina-fill {
    height:100%; width:100%; border-radius:6px;
    transition:width 0.3s ease-out, background 0.5s;
    background:linear-gradient(to right,#f04545,#f0c040,#6ddb4a);
    background-size:380px 100%;
  }

  /* Sweet spot zone overlay on tension bar */
  #sweet-spot {
    position:absolute; top:0; height:100%; width:18%;
    background:rgba(109,219,74,0.25); border-left:2px solid rgba(109,219,74,0.7);
    border-right:2px solid rgba(109,219,74,0.7);
    transition:left 0.15s ease-out;
    pointer-events:none;
  }
  #sweet-spot::after {
    content:'‚óè'; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    font-size:8px; color:rgba(109,219,74,0.9);
  }
  #tension-warn { text-align:center; font-size:0.68rem; font-weight:900; color:#ff5050; min-height:16px; margin-top:2px; }

  /* Tug indicator */
  #tug-indicator {
    display:flex; align-items:center; justify-content:center; gap:6px;
    margin-top:8px; font-size:0.6rem; font-weight:900; letter-spacing:1.5px;
    text-transform:uppercase; color:rgba(255,255,255,0.3);
  }
  .tug-arrow { font-size:0.9rem; transition:all 0.2s; }
  #tug-indicator.active-reel .tug-arrow.right { color:#38d9c0; transform:scale(1.4); }
  #tug-indicator.active-run  .tug-arrow.left  { color:#f04545; transform:scale(1.4); animation:tugPulse 0.3s infinite alternate; }
  @keyframes tugPulse { from{transform:scale(1.2)} to{transform:scale(1.6)} }

  /* Rod bend icon */
  #rod-bend-icon {
    position:absolute; top:14px; right:16px; font-size:1.6rem; line-height:1;
    transition:transform 0.2s, filter 0.2s;
    pointer-events:none;
  }

  /* ‚îÄ‚îÄ UNIFIED SIDE PANEL ‚îÄ‚îÄ */
  #side-panel { display:none; position:fixed; top:var(--hdr); bottom:var(--ftr); right:0; width:min(360px,95vw);
    background:var(--panel); border-left:3px solid var(--rim); z-index:98; overflow:hidden;
    animation:slideIn 0.22s cubic-bezier(0.34,1.2,0.64,1); flex-direction:column; }
  #side-panel.show { display:flex; }
  #sp-content { flex:1; overflow-y:auto; }
  #sp-content::-webkit-scrollbar { width:4px; }
  #sp-content::-webkit-scrollbar-track { background:var(--ink); }
  #sp-content::-webkit-scrollbar-thumb { background:var(--rim); border-radius:2px; }
  .sp-header { position:sticky; top:0; background:var(--panel); border-bottom:2px solid var(--rim);
    padding:10px 12px 0; display:flex; align-items:flex-end; justify-content:space-between; z-index:1; flex-shrink:0; }
  .sp-tabs { display:flex; gap:2px; }
  .sp-tab { background:transparent; border:2px solid var(--rim); border-bottom:none; border-radius:8px 8px 0 0;
    padding:7px 12px; font-family:'Nunito',sans-serif; font-size:0.72rem; font-weight:900; letter-spacing:0.5px;
    color:var(--muted); cursor:pointer; transition:all 0.15s; }
  .sp-tab:hover { background:#1e321e; color:var(--txt); }
  .sp-tab.active { background:var(--ink); border-color:var(--lime); color:var(--lime); }
  .sp-close { width:30px; height:30px; background:var(--ink); border:2px solid var(--rim); border-radius:8px;
    cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:1rem; color:var(--muted);
    transition:all 0.15s; margin-bottom:2px; }
  .sp-close:hover { border-color:var(--red); color:var(--red); }
  .ep-fish-card { margin:10px; background:var(--ink); border:2px solid var(--rim); border-radius:14px; overflow:hidden; transition:border-color 0.2s,box-shadow 0.2s; }
  .ep-fish-card:hover { border-color:#4a7a4a; box-shadow:0 4px 16px rgba(109,219,74,0.1); }
  .ep-fish-top { display:flex; align-items:center; gap:12px; padding:12px 14px 10px; }
  .ep-fish-emoji { font-size:2.4rem; line-height:1; }
  .ep-fish-meta { flex:1; }
  .ep-fish-name { font-family:'Black Han Sans',sans-serif; font-size:1rem; letter-spacing:1.5px; color:var(--txt); }
  .ep-fish-latin { font-size:0.62rem; color:var(--muted); font-style:italic; margin-top:1px; }
  .ep-price-badge { background:rgba(240,192,64,0.12); border:1px solid rgba(240,192,64,0.3); border-radius:20px; padding:2px 9px; font-size:0.7rem; font-weight:900; color:var(--gold); }
  .ep-divider { height:1px; background:var(--rim); margin:0 14px; }
  .ep-stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:0; padding:8px 0; }
  .ep-stat { display:flex; flex-direction:column; align-items:center; gap:2px; padding:6px 4px; border-right:1px solid var(--rim); }
  .ep-stat:last-child { border-right:none; }
  .ep-stat-lbl { font-size:0.55rem; font-weight:900; text-transform:uppercase; letter-spacing:1px; color:var(--muted); }
  .ep-stat-val { font-size:0.82rem; font-weight:700; color:var(--txt); }
  .ep-depth-section { padding:8px 14px 6px; }
  .ep-section-lbl { font-size:0.58rem; font-weight:900; text-transform:uppercase; letter-spacing:1.5px; color:var(--muted); margin-bottom:5px; }
  .ep-depth-vis { display:flex; align-items:center; gap:6px; }
  .ep-depth-track { flex:1; height:10px; background:var(--panel); border:1px solid var(--rim); border-radius:5px; overflow:hidden; }
  .ep-depth-fill { height:100%; border-radius:5px; background:linear-gradient(to right,#38d9c0,#1a4a6e); }
  .ep-depth-label { font-size:0.7rem; font-weight:700; color:var(--cyan); min-width:44px; text-align:right; }
  .ep-bait-section { padding:6px 14px 14px; }
  .ep-bait-chips { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }
  .ep-bait-chip { display:flex; align-items:center; gap:4px; padding:3px 9px 3px 6px; border-radius:20px; font-size:0.7rem; font-weight:700; border:2px solid var(--rim); background:var(--panel); color:var(--muted); transition:all 0.15s; }
  .ep-bait-chip.fav { border-color:var(--gold); background:rgba(240,192,64,0.12); color:var(--gold); }
  .ep-bait-chip .chip-star { font-size:0.6rem; }

  @keyframes slideIn { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
  .shop-balance { margin:12px 12px 4px; background:rgba(240,192,64,0.1); border:1px solid rgba(240,192,64,0.3); border-radius:12px; padding:10px 14px; display:flex; align-items:center; justify-content:space-between; }
  .shop-balance-lbl { font-size:0.65rem; font-weight:900; text-transform:uppercase; letter-spacing:2px; color:var(--muted); }
  .shop-balance-val { font-size:1.1rem; font-weight:900; color:var(--gold); }
  .shop-section-lbl { margin:14px 14px 6px; font-size:0.65rem; font-weight:900; text-transform:uppercase; letter-spacing:2px; color:#aa77dd; }
  .shop-item { margin:6px 10px; background:var(--ink); border:2px solid var(--rim); border-radius:14px; padding:12px 14px; display:flex; align-items:center; gap:12px; transition:border-color 0.15s,box-shadow 0.15s; }
  .shop-item:hover { border-color:#6633aa; box-shadow:0 4px 16px rgba(100,50,180,0.2); }
  .shop-item-icon { font-size:2rem; line-height:1; flex-shrink:0; }
  .shop-item-info { flex:1; }
  .shop-item-name { font-family:'Black Han Sans',sans-serif; font-size:0.9rem; letter-spacing:1px; color:var(--txt); }
  .shop-item-desc { font-size:0.62rem; color:var(--muted); margin-top:2px; }
  .shop-item-qty { font-size:0.65rem; font-weight:900; color:var(--cyan); margin-top:2px; }
  .shop-buy-btn { background:linear-gradient(160deg,#8855cc,#4422aa); color:#f0e0ff; border:none; border-radius:10px; padding:8px 14px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.8rem; cursor:pointer; flex-shrink:0; transition:transform 0.1s,filter 0.1s; box-shadow:0 3px 0 #220066; position:relative; }
  .shop-buy-btn::after { content:''; position:absolute; bottom:0; left:4px; right:4px; height:3px; border-radius:0 0 8px 12px; background:rgba(0,0,0,0.3); }
  .shop-buy-btn:hover { filter:brightness(1.15); transform:translateY(-2px); }
  .shop-buy-btn:active { transform:translateY(1px) scale(0.96); }
  .shop-buy-btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; }
  .shop-divider { height:2px; background:var(--rim); margin:10px 14px; border-radius:1px; }

  /* ‚îÄ‚îÄ SHOP FILTER TABS ‚îÄ‚îÄ */
  .shop-filters { display:flex; gap:6px; padding:10px 12px 4px; flex-wrap:wrap; }
  .shop-filter-btn { display:flex; align-items:center; gap:5px; padding:6px 12px; background:var(--ink);
    border:2px solid var(--rim); border-radius:20px; font-family:'Nunito',sans-serif; font-weight:900;
    font-size:0.7rem; color:var(--muted); cursor:pointer; transition:all 0.15s; white-space:nowrap; }
  .shop-filter-btn:hover { border-color:#6633aa; color:var(--txt); }
  .shop-filter-btn.active { background:rgba(136,85,204,0.18); border-color:#8855cc; color:#cc99ff; box-shadow:0 0 10px rgba(136,85,204,0.3); }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  #toast { position:fixed; top:calc(var(--hdr)+16px); left:50%; transform:translateX(-50%) translateY(-8px);
    background:rgba(10,22,11,0.92); border:2px solid var(--lime); border-radius:24px; padding:9px 22px;
    font-size:0.88rem; font-weight:700; pointer-events:none; opacity:0; transition:opacity 0.22s,transform 0.22s;
    z-index:110; white-space:nowrap; color:var(--lime); box-shadow:0 6px 28px rgba(0,0,0,0.6),0 0 0 1px rgba(109,219,74,0.15);
    backdrop-filter:blur(8px); max-width:calc(100vw - 32px); text-align:center; }
  #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

  /* ‚îÄ‚îÄ CATCH CARD MODAL ‚îÄ‚îÄ */
  #modal {
    display:none; position:fixed; inset:0; z-index:200;
    justify-content:center; align-items:center; padding:16px;
    background: radial-gradient(ellipse at 50% 40%, rgba(4,28,48,0.97) 0%, rgba(0,0,0,0.97) 100%);
  }
  #modal.show { display:flex; }

  .catch-card {
    background: linear-gradient(170deg,#0a1e2a 0%,#081610 60%,#0c1a0e 100%);
    border:2px solid rgba(56,217,192,0.3);
    border-radius:26px; max-width:360px; width:100%; overflow:hidden;
    box-shadow: 0 0 0 1px rgba(56,217,192,0.08), 0 0 50px rgba(56,217,192,0.1), 0 40px 80px rgba(0,0,0,0.9);
    animation: catchPop 0.45s cubic-bezier(0.34,1.4,0.64,1) both;
  }
  @keyframes catchPop {
    0%  { opacity:0; transform:scale(0.55) translateY(50px); }
    100%{ opacity:1; transform:scale(1)    translateY(0); }
  }

  /* Art area */
  .catch-card-art {
    position:relative; height:190px;
    background: linear-gradient(180deg,#041622 0%,#062036 50%,#08243e 100%);
    display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  .catch-card-art::before {
    content:''; position:absolute; inset:0;
    background: radial-gradient(ellipse at 50% 65%, rgba(56,217,192,0.14) 0%, transparent 60%);
    animation: artGlow 2.8s ease-in-out infinite;
  }
  @keyframes artGlow { 0%,100%{opacity:0.7} 50%{opacity:1.2} }
  .catch-card-art::after {
    content:''; position:absolute; bottom:0; left:0; right:0; height:60px;
    background: linear-gradient(0deg, rgba(8,22,14,0.95) 0%, transparent 100%);
    pointer-events:none;
  }

  /* Animated water ripple lines */
  .catch-card-water {
    position:absolute; bottom:0; left:0; right:0; height:70px; overflow:hidden;
  }
  .catch-card-water::before, .catch-card-water::after {
    content:''; position:absolute; left:-60%; width:220%; height:1.5px;
    background: linear-gradient(90deg, transparent 0%, rgba(56,217,192,0.35) 40%, rgba(109,219,74,0.2) 60%, transparent 100%);
    animation: waveScroll 4s linear infinite;
  }
  .catch-card-water::before { bottom:28px; }
  .catch-card-water::after  { bottom:14px; animation-duration:5.5s; animation-delay:-2s; opacity:0.6; }
  @keyframes waveScroll { from{transform:translateX(0)} to{transform:translateX(45.5%)} }

  #catch-fish-canvas { position:relative; z-index:1; display:block; }

  .catch-pb-badge {
    position:absolute; top:0; left:50%; transform:translateX(-50%) translateY(-1px);
    background: linear-gradient(135deg,#f0c040,#b86a00);
    border-radius:0 0 14px 14px; padding:5px 20px 7px;
    font-size:0.7rem; font-weight:900; letter-spacing:2px; text-transform:uppercase;
    color:#1a0800; z-index:3;
    box-shadow: 0 4px 16px rgba(240,160,0,0.5);
    animation: badgeDrop 0.4s cubic-bezier(0.34,1.5,0.64,1) 0.3s both;
  }
  @keyframes badgeDrop { from{opacity:0;transform:translateX(-50%) translateY(-20px)} to{opacity:1;transform:translateX(-50%) translateY(-1px)} }

  /* Card body */
  .catch-card-body { padding:18px 20px 20px; }

  .catch-fish-name {
    font-family:'Black Han Sans',sans-serif; font-size:1.9rem; letter-spacing:3px;
    text-align:center; line-height:1; margin-bottom:3px;
    background: linear-gradient(135deg,#f0c040 0%,#6ddb4a 55%,#38d9c0 100%);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    animation: fadeUp 0.3s ease-out 0.15s both;
  }
  .catch-fish-latin {
    text-align:center; font-size:0.66rem; color:rgba(122,170,122,0.65);
    font-style:italic; margin-bottom:16px;
    animation: fadeUp 0.3s ease-out 0.22s both;
  }
  @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

  .catch-stats-row {
    display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:14px;
    animation: fadeUp 0.3s ease-out 0.3s both;
  }
  .catch-stat {
    background: rgba(14,36,22,0.8); border:1px solid rgba(56,217,192,0.18);
    border-radius:14px; padding:11px 6px; text-align:center; position:relative; overflow:hidden;
  }
  .catch-stat::after {
    content:''; position:absolute; top:0; left:10%; right:10%; height:1px;
    background: linear-gradient(90deg, transparent, rgba(56,217,192,0.4), transparent);
  }
  .catch-stat-val {
    font-family:'Black Han Sans',sans-serif; font-size:1.2rem; line-height:1;
    color:var(--gold); text-shadow: 0 0 12px rgba(240,192,64,0.3);
  }
  .catch-stat-lbl { font-size:0.55rem; font-weight:900; text-transform:uppercase; letter-spacing:1.5px; color:rgba(56,217,192,0.55); margin-top:4px; }

  .catch-pb-row {
    text-align:center; margin-bottom:14px; font-size:0.72rem; color:var(--muted); min-height:18px;
    animation: fadeUp 0.3s ease-out 0.36s both;
  }
  .catch-pb-row span { color:var(--gold); font-weight:900; }

  .catch-divider {
    height:1px; margin-bottom:14px;
    background: linear-gradient(90deg, transparent, rgba(56,217,192,0.2), transparent);
  }

  .catch-btns {
    display:grid; grid-template-columns:1fr 1fr; gap:10px;
    animation: fadeUp 0.3s ease-out 0.42s both;
  }
  .catch-btn {
    height:54px; border:none; border-radius:15px; font-family:'Nunito',sans-serif; font-weight:900;
    font-size:0.95rem; cursor:pointer; position:relative; overflow:hidden;
    display:flex; align-items:center; justify-content:center; gap:6px;
    transition:transform 0.12s, filter 0.12s;
  }
  .catch-btn:hover { filter:brightness(1.15); transform:translateY(-2px); }
  .catch-btn:active { transform:translateY(1px) scale(0.97); }
  .catch-btn::before {
    content:''; position:absolute; top:0; left:-100%; width:60%; height:100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.18), transparent);
    transform: skewX(-20deg); transition: left 0.5s;
  }
  .catch-btn:hover::before { left:160%; }
  .catch-btn-keep { background:linear-gradient(160deg,#50ca30,#2a8018); color:#051505; box-shadow:0 4px 0 #165010, 0 6px 24px rgba(78,200,46,0.3); }
  .catch-btn-sell { background:linear-gradient(160deg,#f5ca44,#bf7a0a); color:#1a0800; box-shadow:0 4px 0 #7a4a00, 0 6px 24px rgba(245,200,66,0.28); }
  .catch-btn-sell .sell-price { font-size:0.8rem; opacity:0.85; }

  /* ‚îÄ‚îÄ AQUARIUM / START SCREEN ‚îÄ‚îÄ */
  #aquarium-screen { display:none; position:fixed; inset:0; background:#060e1a; z-index:150; overflow:hidden; }
  #aquarium-screen.show { display:block; }
  #aq-canvas { position:absolute; inset:0; width:100%; height:100%; display:block; }
  #aq-header { position:absolute; top:0; left:0; right:0; padding:28px 0 16px; display:flex; flex-direction:column; align-items:center; gap:4px; background:linear-gradient(180deg,rgba(6,14,26,0.92) 0%,rgba(6,14,26,0.6) 70%,transparent 100%); z-index:4; pointer-events:none; }
  .aq-brand-row { display:flex; align-items:center; gap:10px; }
  .aq-logo-icon { font-size:3.2rem; line-height:1; animation:phishyBob 2.8s ease-in-out infinite; filter:drop-shadow(0 0 12px rgba(56,217,192,0.7)); }
  @keyframes phishyBob { 0%,100%{transform:translateY(0px) scaleX(1)} 25%{transform:translateY(-6px) scaleX(1.05)} 75%{transform:translateY(4px) scaleX(0.97)} }
  .aq-brand-wordmark { display:flex; flex-direction:column; line-height:1; }
  .aq-brand-name { font-family:'Black Han Sans',sans-serif; font-size:3.4rem; letter-spacing:8px;
    background:linear-gradient(135deg,#f0c040 0%,#6ddb4a 45%,#38d9c0 100%);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    filter:drop-shadow(0 2px 16px rgba(56,217,192,0.4)); padding-right:8px; }
  .aq-brand-sub { font-size:0.6rem; letter-spacing:5px; font-weight:900; color:#38d9c0; opacity:0.7; text-transform:uppercase; text-align:center; margin-top:2px; }
  .aq-divider { width:120px; height:2px; margin-top:8px; background:linear-gradient(90deg,transparent,#38d9c0,#6ddb4a,#38d9c0,transparent); border-radius:1px; animation:dividerPulse 3s ease-in-out infinite; }
  @keyframes dividerPulse { 0%,100%{opacity:0.5;width:100px} 50%{opacity:1;width:160px} }
  #aq-footer { position:absolute; bottom:0; left:0; right:0; padding:0 0 32px; background:linear-gradient(0deg,rgba(6,14,26,0.95) 0%,rgba(6,14,26,0.7) 70%,transparent 100%); display:flex; flex-direction:column; align-items:center; gap:14px; z-index:4; }
  #aq-collection { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; padding:0 20px; max-width:560px; }
  .aq-pill { display:flex; align-items:center; gap:5px; background:rgba(14,28,42,0.8); border:1px solid rgba(56,217,192,0.25); border-radius:20px; padding:5px 12px 5px 7px; font-size:0.7rem; font-weight:700; color:#b8e8d8; backdrop-filter:blur(6px); animation:pillIn 0.4s cubic-bezier(0.34,1.3,0.64,1) both; }
  @keyframes pillIn { from{opacity:0;transform:scale(0.7) translateY(8px)} to{opacity:1;transform:scale(1) translateY(0)} }
  .aq-pill-emoji { font-size:1.15rem; }
  .aq-pill-wt { color:#38d9c0; margin-left:3px; font-size:0.65rem; }
  #aq-empty-hint { font-size:0.72rem; letter-spacing:3px; color:rgba(56,217,192,0.45); text-transform:uppercase; font-weight:700; }
  .aq-go-btn { width:calc(100% - 48px); max-width:300px; height:60px; background:linear-gradient(160deg,#6ddb4a,#1e6614); border:none; border-radius:14px; cursor:pointer; font-family:'Black Han Sans',sans-serif; font-size:1.25rem; letter-spacing:4px; color:#071206; box-shadow:0 5px 0 #124010,0 8px 32px rgba(109,219,74,0.45); transition:transform 0.1s,box-shadow 0.1s; display:flex; align-items:center; justify-content:center; gap:10px; }
  .aq-go-btn:active { transform:translateY(3px); box-shadow:0 2px 0 #124010,0 4px 16px rgba(109,219,74,0.3); }
  .aq-go-btn .btn-fish-icon { font-size:1.4rem; }

  /* ‚îÄ‚îÄ STATE INDICATOR ‚îÄ‚îÄ */
  #state-indicator { position:fixed; bottom:12px; left:50%; transform:translateX(-50%); background:rgba(14,26,15,0.9); border:2px solid var(--rim); border-radius:20px; padding:6px 16px; font-size:0.7rem; font-weight:900; letter-spacing:2px; text-transform:uppercase; color:var(--muted); z-index:96; pointer-events:none; transition:opacity 0.3s; opacity:0; }
  #state-indicator.show { opacity:1; }

  /* ‚îÄ‚îÄ GEAR (ROD/REEL) DISPLAY IN HEADER ‚îÄ‚îÄ */
  .journal-stats-bar { margin:12px 12px 4px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }
  .journal-stat-tile { background:var(--ink); border:2px solid var(--rim); border-radius:12px; padding:10px 8px; text-align:center; }
  .journal-stat-tile .jst-val { font-family:'Black Han Sans',sans-serif; font-size:1.3rem; color:var(--gold); }
  .journal-stat-tile .jst-lbl { font-size:0.58rem; font-weight:900; text-transform:uppercase; letter-spacing:1px; color:var(--muted); margin-top:2px; }
  .journal-section-lbl { margin:14px 14px 6px; font-size:0.65rem; font-weight:900; text-transform:uppercase; letter-spacing:2px; color:#4ab898; }
  .journal-record-card { margin:6px 10px; background:var(--ink); border:2px solid var(--rim); border-radius:14px; padding:12px 14px; display:flex; align-items:center; gap:12px; transition:border-color 0.2s; }
  .journal-record-card:hover { border-color:#3a6a5a; }
  .journal-record-card.has-record { border-color:rgba(56,217,192,0.3); }
  .journal-record-emoji { font-size:2rem; flex-shrink:0; }
  .journal-record-info { flex:1; }
  .journal-record-name { font-family:'Black Han Sans',sans-serif; font-size:0.9rem; letter-spacing:1px; color:var(--txt); }
  .journal-record-best { font-size:0.78rem; font-weight:700; color:var(--cyan); margin-top:2px; }
  .journal-record-count { font-size:0.62rem; color:var(--muted); margin-top:1px; }
  .journal-record-badge { background:linear-gradient(135deg,#1a3a34,#0e2420); border:1px solid rgba(56,217,192,0.4); border-radius:10px; padding:4px 10px; font-size:0.7rem; font-weight:900; color:var(--cyan); white-space:nowrap; }
  .journal-entry-list { padding:0 10px 14px; }
  .journal-entry { display:flex; align-items:center; gap:10px; padding:8px 10px; background:var(--ink); border:1px solid var(--rim); border-radius:10px; margin-bottom:5px; }
  .journal-entry-emoji { font-size:1.3rem; }
  .journal-entry-info { flex:1; font-size:0.72rem; color:var(--txt); }
  .journal-entry-info b { color:var(--gold); }
  .journal-entry-time { font-size:0.6rem; color:var(--muted); }
  .journal-empty { padding:32px 20px; text-align:center; color:var(--muted); font-size:0.8rem; }

  /* ‚îÄ‚îÄ GEAR (ROD/REEL) DISPLAY IN HEADER ‚îÄ‚îÄ */
  #gear-badge { display:flex; align-items:center; gap:4px; background:rgba(14,26,15,0.8); border:2px solid var(--rim);
    border-radius:16px; padding:4px 10px; font-size:0.72rem; font-weight:900; color:var(--muted);
    pointer-events:none; }

  /* ‚îÄ‚îÄ SHOP GEAR SECTION ‚îÄ‚îÄ */
  .shop-gear-item { margin:6px 10px; background:var(--ink); border:2px solid var(--rim); border-radius:14px; padding:12px 14px; }
  .shop-gear-item.owned { border-color:rgba(56,217,192,0.4); }
  .shop-gear-tier { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
  .shop-gear-icon { font-size:1.6rem; }
  .shop-gear-meta { flex:1; }
  .shop-gear-name { font-family:'Black Han Sans',sans-serif; font-size:0.88rem; color:var(--txt); }
  .shop-gear-desc { font-size:0.6rem; color:var(--muted); margin-top:2px; }
  .shop-gear-stats { display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }
  .shop-gear-stat { background:rgba(56,217,192,0.08); border:1px solid rgba(56,217,192,0.2); border-radius:8px; padding:2px 8px; font-size:0.6rem; font-weight:900; color:var(--cyan); }
  .shop-gear-owned-badge { font-size:0.65rem; font-weight:900; color:var(--lime); border:1px solid var(--lime); border-radius:8px; padding:2px 8px; background:rgba(109,219,74,0.08); }
</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div class="logo">
    <span class="logo-fish">üêü</span>
    <span class="logo-text">PHISHY</span>
  </div>
  <div class="hdr-right">
    <div class="ic-btn" id="btn-aquarium" title="Aquarium" onclick="showAquarium()">üè†</div>
    <div class="ic-btn" id="btn-panel" title="Shop / Fish Guide / Catch Log" onclick="toggleSidePanel('shop')">üìñ</div>
    <div class="ic-btn" id="btn-debug" title="Debug" onclick="toggleDebug()">üêõ</div>
    <div class="ic-btn" onclick="adjustZoom(0.15)" title="Zoom In">Ôºã</div>
    <div class="ic-btn" onclick="adjustZoom(-0.15)" title="Zoom Out">Ôºç</div>
    <div class="ic-btn" onclick="resetView()" title="Reset View">‚åñ</div>
  </div>
</div>

<!-- FLOATING MONEY BADGE -->
<div id="money-float"><span>ü™ô</span> $<span id="money-amount">0</span></div>

<!-- BAIT BOX POPUP -->
<div id="bait-box">
  <div class="bb-step-indicator">
    <div class="bb-step active" id="bb-step1">1 ¬∑ BAIT</div>
    <div class="bb-step" id="bb-step2">2 ¬∑ DEPTH</div>
  </div>
  <div id="bb-bait-section">
    <div class="bb-title">üéí CHOOSE BAIT</div>
    <div class="bb-grid" id="bait-box-grid"></div>
  </div>
  <div id="bb-depth-section" style="display:none">
    <div class="bb-title">üåä CHOOSE DEPTH</div>
    <div class="bb-depth-row" id="depth-btns"></div>
    <button class="bb-confirm-btn show" id="bb-confirm-btn" onclick="confirmBaitAndDepth()">‚úÖ CONFIRM &amp; READY TO CAST</button>
  </div>
</div>

<!-- DISTANCE HUD (shown during fight AND while fishing) -->
<div id="dist-hud"></div>

<!-- VIEWPORT -->
<div id="viewport">
  <canvas id="gameCanvas"></canvas>
</div>

<!-- FLOATING SIDE BUTTONS -->
<div id="side-btns">
  <button class="side-fab fab-cast" id="fab-cast" onclick="handleFabCast()" style="display:none">
    <span class="fab-icon" id="fab-cast-icon">üéØ</span>
    <span id="fab-cast-label">CAST</span>
  </button>
  <button class="side-fab fab-bait-box" id="fab-baitbox" onclick="toggleBaitBox()" style="display:none">
    <span class="fab-icon">üéí</span>BAITS
  </button>
  <div class="fab-sep" id="fab-sep1" style="display:none"></div>
  <button class="side-fab fab-reel" id="fab-reel"
    onmousedown="fabReelDown(event)" onmouseup="fabReelUp(event)"
    ontouchstart="fabReelDown(event)" ontouchend="fabReelUp(event)"
    style="display:none">
    <span class="fab-icon" id="fab-reel-icon">üîÑ</span>
    <span id="fab-reel-label">REEL</span>
  </button>
  <button class="side-fab fab-groundbait" id="fab-gb" style="display:none">
    <span class="fab-icon">ü™£</span>BAIT
  </button>
</div>

<!-- FIGHT HUD (unified) -->
<div id="tension-hud">
  <span id="rod-bend-icon">üé£</span>
  <div id="fight-fish-row">
    <div id="fight-fish-name">FISH ON!</div>
    <div id="fight-phase-badge" class="fresh">üí™ FRESH</div>
  </div>
  <div id="fight-status-banner" class="resting">üí§ RESTING ‚Äî Hold REEL to bring it in!</div>
  <div class="fight-bars">
    <div class="fight-bar-row">
      <div class="fight-bar-label">‚ö° LINE</div>
      <div class="fight-bar-outer">
        <div id="tension-fill" data-pct="0%"></div>
        <div id="sweet-spot" style="left:30%"></div>
      </div>
    </div>
    <div class="fight-bar-row">
      <div class="fight-bar-label">üí™ FISH</div>
      <div class="fight-bar-outer"><div id="stamina-fill"></div></div>
    </div>
  </div>
  <div id="tug-indicator">
    <span class="tug-arrow left">‚óÄ‚óÄ</span>
    <span style="letter-spacing:2px">TUG-O-WAR</span>
    <span class="tug-arrow right">‚ñ∂‚ñ∂</span>
  </div>
  <div id="tension-warn"></div>
</div>
<div id="side-panel">
  <div class="sp-header">
    <div class="sp-tabs">
      <button class="sp-tab" id="tab-shop" onclick="switchTab('shop')">üõí SHOP</button>
      <button class="sp-tab" id="tab-encyc" onclick="switchTab('encyc')">üìñ GUIDE</button>
      <button class="sp-tab" id="tab-journal" onclick="switchTab('journal')">üìì LOG</button>
    </div>
    <div class="sp-close" onclick="closeSidePanel()">‚úï</div>
  </div>
  <div id="sp-content"></div>
</div>

<!-- AQUARIUM / START SCREEN -->
<div id="aquarium-screen">
  <canvas id="aq-canvas"></canvas>
  <div id="aq-header">
    <div class="aq-brand-row">
      <span class="aq-logo-icon">üêü</span>
      <div class="aq-brand-wordmark">
        <span class="aq-brand-name">PHISHY</span>
        <span class="aq-brand-sub">Cast ¬∑ Fight ¬∑ Catch</span>
      </div>
    </div>
    <div class="aq-divider"></div>
  </div>
  <div id="aq-footer">
    <div id="aq-collection"></div>
    <div id="aq-empty-hint" style="display:none">ü™£ &nbsp;Your tank is empty ‚Äî go catch some fish!</div>
    <button class="aq-go-btn" onclick="startFishing()">
      <span class="btn-fish-icon">üé£</span>GO FISHING
    </button>
  </div>
</div>

<!-- CATCH CARD MODAL -->
<div id="modal">
  <div class="catch-card">
    <div class="catch-card-art">
      <div class="catch-card-water"></div>
      <canvas id="catch-fish-canvas" width="280" height="140"></canvas>
      <div class="catch-pb-badge" id="catch-pb-badge" style="display:none"></div>
    </div>
    <div class="catch-card-body">
      <div class="catch-fish-name" id="modal-name"></div>
      <div class="catch-fish-latin" id="modal-latin"></div>
      <div class="catch-stats-row">
        <div class="catch-stat"><div class="catch-stat-val" id="catch-weight">‚Äî</div><div class="catch-stat-lbl">Weight</div></div>
        <div class="catch-stat"><div class="catch-stat-val" id="catch-size">‚Äî</div><div class="catch-stat-lbl">Length</div></div>
        <div class="catch-stat"><div class="catch-stat-val" id="catch-value">‚Äî</div><div class="catch-stat-lbl">Value</div></div>
      </div>
      <div class="catch-pb-row" id="catch-pb-row"></div>
      <div class="catch-btns">
        <button class="catch-btn catch-btn-keep" onclick="keepFish()">üè† KEEP</button>
        <button class="catch-btn catch-btn-sell" onclick="releaseFish()">ü™ô SELL <span class="sell-price" id="release-value"></span></button>
      </div>
    </div>
  </div>
</div>

<!-- STATE INDICATOR -->
<div id="state-indicator"></div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS & WORLD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WORLD_W = 2400;
const WORLD_H = 1800;

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = WORLD_W;
canvas.height = WORLD_H;

let viewX = 0, viewY = 0, viewScale = 1;
let isDragging = false, dragStartX, dragStartY, dragViewX, dragViewY;

// Delta time
let lastFrameTime = 0;
let dt = 0; // seconds per frame, capped at 0.1

let gameState = 'aquarium';
let selectedPeg = null;
let selectedBait = null;
let floatDepth = 1;
let angleSweep = 0, sweepDir = 1;
let powerLevel = 0, powerDir = 1;
let floatPos = null;
let bobPhase = 0;
let bobDriftX = 0, bobDriftY = 0, bobDriftAngle = 0;
let debugMode = false;
let groundBait = [];
let fishList = [];
let hookedFish = null;
let biteDelay = 0;
let fishRunning = false;
let runTimer = 0, restTimer = 0;
let fishStamina = 100; // hidden fish stamina ‚Äî drives fight arc
let lineHealth = 100;
let isReeling = false;
let caughtFish = null;
let playerMoney = 0;
let aquariumFish = [];
let castSinking = false;
let sinkProgress = 0;
let castLine = null;
let tension = 0;
let isReelIn = false;
let groundBaitStock = 5;
let reelVelocity = 0; // eased reel speed
let sweetSpotPos = 30;  // fight sweet-spot zone position (%)
let sweetSpotDir = 1;
let sweetSpotInZone = false;

// Rod/Reel gear
const rodTiers = [
  { id:'rod_basic',   name:'Starter Rod',   icon:'üé£', castMult:1.0, price:0,   desc:'Standard 10ft rod. Gets the job done.',        owned:true  },
  { id:'rod_mid',     name:'Match Rod',     icon:'üé£', castMult:1.35,price:120,  desc:'+35% cast range. Lighter, better accuracy.',  owned:false },
  { id:'rod_pro',     name:'Carp Rod',      icon:'üé£', castMult:1.7, price:350,  desc:'+70% cast range. High-vis tip for bite detection.', owned:false },
];
const reelTiers = [
  { id:'reel_basic',  name:'Starter Reel',  icon:'‚öôÔ∏è', tensionMax:100, reelMult:1.0, price:0,   desc:'Standard fixed-spool. 8lb line.',            owned:true  },
  { id:'reel_mid',    name:'Match Reel',    icon:'‚öôÔ∏è', tensionMax:130, reelMult:1.4, price:100,  desc:'+30% breaking strain. Faster retrieve.',     owned:false },
  { id:'reel_pro',    name:'Baitrunner',    icon:'‚öôÔ∏è', tensionMax:175, reelMult:1.9, price:280,  desc:'+75% breaking strain. Top-of-the-range.',    owned:false },
];
let equippedRod  = 'rod_basic';
let equippedReel = 'reel_basic';

function getActiveRod()  { return rodTiers.find(r=>r.id===equippedRod);  }
function getActiveReel() { return reelTiers.find(r=>r.id===equippedReel); }

// Journal / records
let catchLog    = []; // {type, weight, size, emoji, gameTimeStr, timestamp}
let speciesRecords = {}; // { 'Carp': {bestWeight, count}, ... }

let baitInventory = {
  sweetcorn: 10,
  worm: 10,
  bread: 10,
  pellet: 10,
  maggot: 10,
  boilie: 0,
  luncheonmeat: 0,
  tiger_nut: 0
};

// Day/Night
let dayStartMs = Date.now() - 110000;
function getDayTime() {
  const cycleDur = debugMode ? 120000 : 720000;
  return ((Date.now() - dayStartMs) % cycleDur) / cycleDur;
}
function getGameTimeStr() {
  // Map 0‚Äì1 day cycle with offset so dusk (t=0.42) ‚âà 04:30
  // Offset = 18h25m = 1105 mins
  const t = getDayTime();
  const totalMins = (Math.round(t * 1440) + 1105) % 1440;
  const h = Math.floor(totalMins / 60) % 24;
  const m = totalMins % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function getDayPhase() {
  const t = getDayTime();
  if (t < 0.08 || t >= 0.58) return 'night';
  if (t < 0.22) return 'dawn';
  if (t < 0.42) return 'day';
  return 'dusk';
}
function getNightFactor() {
  const t = getDayTime();
  if (t >= 0.22 && t < 0.42) return 0;
  if (t >= 0.62 || t < 0.08) return 1;
  if (t >= 0.08 && t < 0.22) { const p=(t-0.08)/0.14; return 1-smoothstep(p); }
  if (t >= 0.42 && t < 0.58) { const p=(t-0.42)/0.16; return smoothstep(p); }
  const p=(t-0.58)/0.04; return 0.85+smoothstep(p)*0.15;
}
function smoothstep(t) { return t*t*(3-2*t); }
function getSkyOverlay() {
  const phase = getDayPhase(), t = getDayTime();
  if (phase==='night') return {r:0,g:10,b:40,a:0.60};
  return {r:0,g:0,b:0,a:0};
}

// Audio
let audioCtx;
function ensureAudio() { if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }

function playTone(freq,type,dur,vol=0.2) {
  ensureAudio();
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type=type; o.frequency.value=freq;
  g.gain.setValueAtTime(vol,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
  o.start(); o.stop(audioCtx.currentTime+dur);
}

// UI click ‚Äî short crisp tick
function playUIClick() {
  ensureAudio();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.connect(g);g.connect(audioCtx.destination);
  o.type='sine';o.frequency.setValueAtTime(880,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(440,audioCtx.currentTime+0.06);
  g.gain.setValueAtTime(0.12,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.06);
  o.start();o.stop(audioCtx.currentTime+0.07);
}

// Cast whoosh + splash
function playCastWhoosh() {
  ensureAudio();
  // Whoosh
  const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.25,audioCtx.sampleRate);
  const d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++){const t=i/d.length;d[i]=(Math.random()*2-1)*Math.exp(-t*6)*t;}
  const src=audioCtx.createBufferSource(),g=audioCtx.createGain();
  const filt=audioCtx.createBiquadFilter();filt.type='bandpass';filt.frequency.value=600+1200*0;filt.Q.value=1.2;
  src.buffer=buf;src.connect(filt);filt.connect(g);g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.3,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.25);
  src.start();
}

function playSplash() {
  ensureAudio();
  // Delay splash slightly after whoosh
  const delay = 0.25;
  const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.35,audioCtx.sampleRate);
  const d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/(audioCtx.sampleRate*0.07));
  const src=audioCtx.createBufferSource(), g=audioCtx.createGain(), filt=audioCtx.createBiquadFilter();
  filt.type='bandpass'; filt.frequency.value=1400; filt.Q.value=0.6;
  src.buffer=buf; src.connect(filt); filt.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.001,audioCtx.currentTime);
  g.gain.setValueAtTime(0.45,audioCtx.currentTime+delay);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+delay+0.3);
  src.start(audioCtx.currentTime+delay);
}

// Hook-up bite alarm ‚Äî urgent beeping
function playHookUp() {
  ensureAudio();
  for(let i=0;i<4;i++){
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.type='square';o.frequency.value=880+i*120;
    const t=audioCtx.currentTime+i*0.12;
    g.gain.setValueAtTime(0.0,t);g.gain.setValueAtTime(0.18,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.001,t+0.09);
    o.start(t);o.stop(t+0.1);
  }
}

// Landing ‚Äî triumphant ascending arpeggio
function playLanding() {
  ensureAudio();
  [523,659,784,1047].forEach((freq,i)=>{
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.type='triangle';o.frequency.value=freq;
    const t=audioCtx.currentTime+i*0.1;
    g.gain.setValueAtTime(0.0,t);g.gain.setValueAtTime(0.22,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.001,t+0.35);
    o.start(t);o.stop(t+0.36);
  });
}

// Line snap
function playLineSnap() {
  ensureAudio();
  const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.2,audioCtx.sampleRate);
  const d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++){const t=i/d.length;d[i]=(Math.random()*2-1)*(1-t)*Math.exp(-t*18);}
  const src=audioCtx.createBufferSource(),g=audioCtx.createGain();
  src.buffer=buf;src.connect(g);g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.5,audioCtx.currentTime);
  src.start();
  // Low thud
  const o=audioCtx.createOscillator(),g2=audioCtx.createGain();
  o.connect(g2);g2.connect(audioCtx.destination);
  o.type='sine';o.frequency.setValueAtTime(120,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(40,audioCtx.currentTime+0.2);
  g2.gain.setValueAtTime(0.3,audioCtx.currentTime);
  g2.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.2);
  o.start();o.stop(audioCtx.currentTime+0.2);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const baits = [
  { id:'sweetcorn', name:'Corn',    icon:'üåΩ', color:'#FFD700', desc:'Bright & sweet ‚Äî carp love it', price:8  },
  { id:'worm',      name:'Worm',    icon:'ü™±', color:'#8B4513', desc:'Classic all-rounder',           price:6  },
  { id:'bread',     name:'Bread',   icon:'üçû', color:'#F5DEB3', desc:'Floats well, roach favourite',  price:5  },
  { id:'pellet',    name:'Pellet',  icon:'üü§', color:'#654321', desc:'High attract ‚Äî carp & bream',   price:10 },
  { id:'maggot',    name:'Maggot',  icon:'üêõ', color:'#fff5d0', desc:'Wriggly ‚Äî perch & roach',       price:7  },
  { id:'boilie',    name:'Boilie',  icon:'üü†', color:'#e06820', desc:'Big fish specialist bait',      price:20 },
  { id:'luncheonmeat', name:'Meat', icon:'ü•©', color:'#cc4444', desc:'Tench & carp magnet',           price:15 },
  { id:'tiger_nut', name:'Tiger Nut', icon:'ü•ú', color:'#c8a040', desc:'Huge carp attractor',        price:25 },
];

const shopItems = [
  { section: 'üé£ Bait', items: [
    { baitId:'sweetcorn', qty:20, price:12,  label:'Sweetcorn √ó20' },
    { baitId:'worm',      qty:20, price:10,  label:'Worms √ó20'     },
    { baitId:'bread',     qty:20, price:8,   label:'Bread √ó20'     },
    { baitId:'pellet',    qty:20, price:15,  label:'Pellets √ó20'   },
    { baitId:'maggot',    qty:20, price:10,  label:'Maggots √ó20'   },
    { baitId:'boilie',    qty:10, price:30,  label:'Boilies √ó10'   },
    { baitId:'luncheonmeat', qty:15, price:20, label:'Luncheon Meat √ó15' },
    { baitId:'tiger_nut', qty:10, price:35,  label:'Tiger Nuts √ó10'},
  ]},
  { section: 'ü™£ Bundles', items: [
    { bundleId:'starter',  price:25, label:'Starter Pack', desc:'Corn√ó30, Worm√ó30, Bread√ó30', bundle:{sweetcorn:30,worm:30,bread:30} },
    { bundleId:'pro',      price:60, label:'Pro Pack',     desc:'All baits √ó20',               bundle:{sweetcorn:20,worm:20,bread:20,pellet:20,maggot:20,boilie:10} },
  ]},
];

const depthOptions = [
  { val:1, label:'Surface', icon:'üåä' },
  { val:2, label:'Mid',     icon:'üîµ' },
  { val:3, label:'Deep',    icon:'üåë' },
];

const fishTypes = [
  { type:'Carp',  latin:'Cyprinus carpio',     color:'#CD7F32', size:22, speed:0.24, depthPref:2, baseWeight:2000, basePrice:50,  emoji:'üêü', favBait:'pellet',    okBaits:['sweetcorn','bread','boilie','tiger_nut'],  depthLabel:'Mid‚ÄìDeep', behavior:'roamer'   },
  { type:'Roach', latin:'Rutilus rutilus',      color:'#C0C0C0', size:12, speed:0.28, depthPref:1, baseWeight:200,  basePrice:10,  emoji:'üê†', favBait:'maggot',    okBaits:['bread','worm'],       depthLabel:'Surface',  behavior:'normal'   },
  { type:'Eel',   latin:'Anguilla anguilla',    color:'#2F4F4F', size:18, speed:0.20, depthPref:3, baseWeight:800,  basePrice:30,  emoji:'üêç', favBait:'worm',      okBaits:['maggot','luncheonmeat'], depthLabel:'Deep', behavior:'nocturnal'},
  { type:'Pike',  latin:'Esox lucius',          color:'#4B8B3B', size:26, speed:0.16, depthPref:2, baseWeight:3000, basePrice:80,  emoji:'ü¶à', favBait:'worm',      okBaits:['pellet'],             depthLabel:'Mid',      behavior:'ambush'   },
  { type:'Bream', latin:'Abramis brama',        color:'#b8860b', size:16, speed:0.15, depthPref:2, baseWeight:600,  basePrice:20,  emoji:'üê°', favBait:'sweetcorn', okBaits:['pellet','maggot'],    depthLabel:'Mid',      behavior:'normal'   },
  { type:'Tench', latin:'Tinca tinca',          color:'#2d6e30', size:14, speed:0.17, depthPref:3, baseWeight:900,  basePrice:35,  emoji:'üê¢', favBait:'bread',     okBaits:['worm','sweetcorn','luncheonmeat'], depthLabel:'Deep', behavior:'normal' },
  { type:'Perch', latin:'Perca fluviatilis',    color:'#4a7a3a', size:15, speed:0.26, depthPref:2, baseWeight:400,  basePrice:22,  emoji:'üé£', favBait:'worm',      okBaits:['maggot','pellet'],    depthLabel:'Mid',      behavior:'normal'   },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LAKE GEOMETRY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LAKE_CENTER = { x:WORLD_W/2, y:WORLD_H/2 };
const LAKE_RX = 900, LAKE_RY = 650;

function lakePoint(angleDeg, rx, ry, wobble) {
  const a = angleDeg*Math.PI/180;
  return { x:LAKE_CENTER.x+Math.cos(a)*rx*(1+wobble), y:LAKE_CENTER.y+Math.sin(a)*ry*(1+wobble) };
}
const LAKE_POINTS = (function() {
  const w=[0,-0.08,0.12,0.05,-0.15,0.09,-0.05,0.18,0.02,-0.1,0.07,0.14,-0.12,0.06,-0.08,0.11,-0.05,0.09,0.13,-0.07,0.04,-0.11,0.08,0.15,-0.09,0.06,-0.13,0.10,-0.04,0.12];
  return w.map((v,i)=>lakePoint(i*12,LAKE_RX,LAKE_RY,v));
})();

function buildLakePath() {
  ctx.beginPath(); ctx.moveTo(LAKE_POINTS[0].x,LAKE_POINTS[0].y);
  for(let i=1;i<LAKE_POINTS.length;i++) {
    const curr=LAKE_POINTS[i], next=LAKE_POINTS[(i+1)%LAKE_POINTS.length];
    ctx.quadraticCurveTo(curr.x,curr.y,(curr.x+next.x)/2,(curr.y+next.y)/2);
  }
  ctx.closePath();
}

const pegs = [
  {id:1,x:LAKE_CENTER.x-920,y:LAKE_CENTER.y-30},
  {id:2,x:LAKE_CENTER.x-640,y:LAKE_CENTER.y-520},
  {id:3,x:LAKE_CENTER.x+0,  y:LAKE_CENTER.y-700},
  {id:4,x:LAKE_CENTER.x+600,y:LAKE_CENTER.y-480},
  {id:5,x:LAKE_CENTER.x+880,y:LAKE_CENTER.y+40},
  {id:6,x:LAKE_CENTER.x+650,y:LAKE_CENTER.y+620},
  {id:7,x:LAKE_CENTER.x+0,  y:LAKE_CENTER.y+710},
  {id:8,x:LAKE_CENTER.x-680,y:LAKE_CENTER.y+580},
];
function pegFacingAngle(peg) {
  return Math.atan2(LAKE_CENTER.y-peg.y,LAKE_CENTER.x-peg.x)*180/Math.PI;
}

const lilyPads = [];
const lilyClusters = [
  {cx:LAKE_CENTER.x-300,cy:LAKE_CENTER.y-200,count:12,spread:110},
  {cx:LAKE_CENTER.x+350,cy:LAKE_CENTER.y+180,count:15,spread:140},
  {cx:LAKE_CENTER.x+100,cy:LAKE_CENTER.y-300,count:8,spread:90},
  {cx:LAKE_CENTER.x-400,cy:LAKE_CENTER.y+300,count:10,spread:120},
  {cx:LAKE_CENTER.x+500,cy:LAKE_CENTER.y-100,count:7,spread:80},
];
lilyClusters.forEach(c=>{
  for(let i=0;i<c.count;i++){
    const a=Math.random()*Math.PI*2,d=Math.random()*c.spread;
    lilyPads.push({x:c.cx+Math.cos(a)*d,y:c.cy+Math.sin(a)*d,r:12+Math.random()*14,rot:Math.random()*Math.PI*2,flower:Math.random()<0.3});
  }
});

const reedPatches=[
  {cx:LAKE_CENTER.x-650,cy:LAKE_CENTER.y-300,count:30,spread:60},
  {cx:LAKE_CENTER.x+600,cy:LAKE_CENTER.y+250,count:25,spread:50},
  {cx:LAKE_CENTER.x-200,cy:LAKE_CENTER.y+580,count:35,spread:70},
  {cx:LAKE_CENTER.x+300,cy:LAKE_CENTER.y-550,count:20,spread:55},
  {cx:LAKE_CENTER.x+750,cy:LAKE_CENTER.y-300,count:18,spread:45},
  {cx:LAKE_CENTER.x-500,cy:LAKE_CENTER.y+500,count:22,spread:60},
];
const reeds=[];
reedPatches.forEach(p=>{
  for(let i=0;i<p.count;i++){
    const a=Math.random()*Math.PI*2,d=Math.random()*p.spread;
    reeds.push({x:p.cx+Math.cos(a)*d,y:p.cy+Math.sin(a)*d,h:40+Math.random()*40,sway:Math.random()*Math.PI*2,swaySpeed:0.02+Math.random()*0.015});
  }
});

let ripples=[];
let carpBubbles=[]; // {x,y,r,alpha,vy}
function addRipple(x,y){ripples.push({x,y,r:5,maxR:60,alpha:0.7});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init() {
  loadData();
  spawnFish();
  updateAquariumDisplay();
  showAquarium();
  resetView();
  gameLoop();
  bindInput();
  bindReelTap();
}

function loadData() {
  try {
    const m=localStorage.getItem('fishingMoney');
    const f=localStorage.getItem('aquariumFish');
    const inv=localStorage.getItem('baitInventory');
    const gbs=localStorage.getItem('groundBaitStock');
    const rods=localStorage.getItem('ownedRods');
    const reels=localStorage.getItem('ownedReels');
    const erod=localStorage.getItem('equippedRod');
    const ereel=localStorage.getItem('equippedReel');
    const jlog=localStorage.getItem('catchLog');
    const jrec=localStorage.getItem('speciesRecords');
    if(m) playerMoney=parseInt(m);
    if(f) aquariumFish=JSON.parse(f);
    if(inv) baitInventory={...baitInventory,...JSON.parse(inv)};
    if(gbs!==null) groundBaitStock=parseInt(gbs);
    if(rods){ const o=JSON.parse(rods); rodTiers.forEach(r=>{ if(o.includes(r.id)) r.owned=true; }); }
    if(reels){ const o=JSON.parse(reels); reelTiers.forEach(r=>{ if(o.includes(r.id)) r.owned=true; }); }
    if(erod) equippedRod=erod;
    if(ereel) equippedReel=ereel;
    if(jlog) catchLog=JSON.parse(jlog);
    if(jrec) speciesRecords=JSON.parse(jrec);
  } catch(e){}
  document.getElementById('money-amount').textContent=playerMoney;
}
function saveData() {
  localStorage.setItem('fishingMoney',playerMoney);
  localStorage.setItem('aquariumFish',JSON.stringify(aquariumFish));
  localStorage.setItem('baitInventory',JSON.stringify(baitInventory));
  localStorage.setItem('groundBaitStock',groundBaitStock);
  localStorage.setItem('ownedRods', JSON.stringify(rodTiers.filter(r=>r.owned).map(r=>r.id)));
  localStorage.setItem('ownedReels', JSON.stringify(reelTiers.filter(r=>r.owned).map(r=>r.id)));
  localStorage.setItem('equippedRod', equippedRod);
  localStorage.setItem('equippedReel', equippedReel);
  localStorage.setItem('catchLog', JSON.stringify(catchLog.slice(-50))); // keep last 50
  localStorage.setItem('speciesRecords', JSON.stringify(speciesRecords));
  document.getElementById('money-amount').textContent=playerMoney;
}

// ‚îÄ‚îÄ UNIFIED SIDE PANEL ‚îÄ‚îÄ
let sidePanelOpen = false;
let activeTab = 'shop';

function toggleSidePanel(tab) {
  playUIClick();
  if (sidePanelOpen && activeTab === tab) {
    closeSidePanel();
  } else {
    sidePanelOpen = true;
    switchTab(tab);
    document.getElementById('side-panel').classList.add('show');
  }
  document.getElementById('btn-panel').classList.toggle('on', sidePanelOpen);
}

function closeSidePanel() {
  sidePanelOpen = false;
  document.getElementById('side-panel').classList.remove('show');
  document.getElementById('btn-panel').classList.remove('on');
}

function switchTab(tab) {
  activeTab = tab;
  ['shop','encyc','journal'].forEach(t => {
    document.getElementById('tab-'+t).classList.toggle('active', t === tab);
  });
  const el = document.getElementById('sp-content');
  el.innerHTML = '';
  if (tab === 'shop') buildShop(el);
  else if (tab === 'encyc') buildEncyc(el);
  else if (tab === 'journal') buildJournal(el);
  sidePanelOpen = true;
}

// Legacy shims so existing call-sites still work
function toggleShop() { toggleSidePanel('shop'); }
function toggleEncyc() { toggleSidePanel('encyc'); }
function toggleJournal() { toggleSidePanel('journal'); }
let shopFilter = 'all';
function buildShop(el) {
  if (!el) el = document.getElementById('sp-content');
  el.innerHTML = '';

  // Balance
  const bal = document.createElement('div');
  bal.className = 'shop-balance';
  bal.innerHTML = `<span class="shop-balance-lbl">Your Balance</span><span class="shop-balance-val">ü™ô $${playerMoney}</span>`;
  el.appendChild(bal);

  // Filter tabs
  const filters = [
    { id:'all',    icon:'üè™', label:'All' },
    { id:'bait',   icon:'üé£', label:'Bait' },
    { id:'bundle', icon:'üéÅ', label:'Bundles' },
    { id:'rod',    icon:'ü™Ñ', label:'Rods' },
    { id:'reel',   icon:'‚öôÔ∏è', label:'Reels' },
  ];
  const filterRow = document.createElement('div');
  filterRow.className = 'shop-filters';
  filters.forEach(f => {
    const btn = document.createElement('button');
    btn.className = 'shop-filter-btn' + (shopFilter===f.id?' active':'');
    btn.innerHTML = `${f.icon} ${f.label}`;
    btn.onclick = () => { shopFilter = f.id; buildShop(document.getElementById('sp-content')); };
    filterRow.appendChild(btn);
  });
  el.appendChild(filterRow);

  const showGear = shopFilter==='all'||shopFilter==='rod'||shopFilter==='reel';
  const showBait = shopFilter==='all'||shopFilter==='bait';
  const showBundle = shopFilter==='all'||shopFilter==='bundle';

  // Gear sections
  if (showGear) {
    const gearSections = [
      { title:'ü™Ñ Rods', tiers: rodTiers, type:'rod', show: shopFilter==='all'||shopFilter==='rod' },
      { title:'‚öôÔ∏è Reels', tiers: reelTiers, type:'reel', show: shopFilter==='all'||shopFilter==='reel' },
    ];
    gearSections.filter(gs=>gs.show).forEach(gs=>{
      const lbl=document.createElement('div');lbl.className='shop-section-lbl';lbl.textContent=gs.title;el.appendChild(lbl);
      gs.tiers.forEach(tier=>{
        const isEquipped = (gs.type==='rod'?equippedRod:equippedReel)===tier.id;
        const row=document.createElement('div');
        row.className='shop-gear-item'+(tier.owned?' owned':'');
        const stats = gs.type==='rod'
          ? `<span class="shop-gear-stat">Cast √ó${tier.castMult.toFixed(2)}</span>`
          : `<span class="shop-gear-stat">Line ${tier.tensionMax}%</span><span class="shop-gear-stat">Reel √ó${tier.reelMult.toFixed(1)}</span>`;
        let actionBtn = '';
        if(tier.owned && isEquipped) actionBtn=`<span class="shop-gear-owned-badge">‚úì EQUIPPED</span>`;
        else if(tier.owned) actionBtn=`<button class="shop-buy-btn" style="background:linear-gradient(160deg,#38d9c0,#1a6a60);box-shadow:0 3px 0 #0a3a30" onclick="equipGear('${gs.type}','${tier.id}')">EQUIP</button>`;
        else actionBtn=`<button class="shop-buy-btn" ${playerMoney<tier.price?'disabled':''} onclick="buyGear('${gs.type}','${tier.id}')">ü™ô$${tier.price}</button>`;
        row.innerHTML=`<div class="shop-gear-tier"><div class="shop-gear-icon">${tier.icon}</div><div class="shop-gear-meta"><div class="shop-gear-name">${tier.name}</div><div class="shop-gear-desc">${tier.desc}</div><div class="shop-gear-stats">${stats}</div></div>${actionBtn}</div>`;
        el.appendChild(row);
      });
      const div=document.createElement('div');div.className='shop-divider';el.appendChild(div);
    });
  }

  // Bait & bundle items
  shopItems.forEach(section => {
    const isBundleSection = section.section.includes('Bundle');
    if (isBundleSection && !showBundle) return;
    if (!isBundleSection && !showBait) return;

    const lbl = document.createElement('div');
    lbl.className = 'shop-section-lbl';
    lbl.textContent = section.section;
    el.appendChild(lbl);

    section.items.forEach(item => {
      const row = document.createElement('div');
      row.className = 'shop-item';
      const bait = baits.find(b=>b.id===item.baitId);
      const icon = bait ? bait.icon : (item.bundleId==='starter'?'üéÅ':'üõçÔ∏è');
      const desc = bait ? bait.desc : item.desc;
      const currentQty = item.baitId ? (baitInventory[item.baitId]||0) : null;
      row.innerHTML = `
        <div class="shop-item-icon">${icon}</div>
        <div class="shop-item-info">
          <div class="shop-item-name">${item.label}</div>
          <div class="shop-item-desc">${desc||''}</div>
          ${currentQty!==null?`<div class="shop-item-qty">In bag: ${currentQty}</div>`:''}
        </div>
        <button class="shop-buy-btn" ${playerMoney<item.price?'disabled':''} onclick="buyItem(${JSON.stringify(item).replace(/"/g,"'")})">
          ü™ô$${item.price}
        </button>`;
      el.appendChild(row);
    });

    const div = document.createElement('div');
    div.className = 'shop-divider';
    el.appendChild(div);
  });
}

function buyGear(type, id) {
  playUIClick();
  const tiers = type==='rod' ? rodTiers : reelTiers;
  const tier = tiers.find(t=>t.id===id);
  if(!tier||tier.owned) return;
  if(playerMoney<tier.price){showToast('Not enough money!');return;}
  playerMoney -= tier.price;
  tier.owned = true;
  equippedRod  = type==='rod'  ? id : equippedRod;
  equippedReel = type==='reel' ? id : equippedReel;
  saveData(); buildShop(); if(sidePanelOpen&&activeTab==='shop') buildShop(document.getElementById('sp-content'));
  showToast(`‚úÖ Bought & equipped ${tier.name}!`);
}

function equipGear(type, id) {
  playUIClick();
  if(type==='rod')  equippedRod=id;
  else              equippedReel=id;
  saveData(); if(sidePanelOpen&&activeTab==='shop') buildShop(document.getElementById('sp-content'));
  const tier=(type==='rod'?rodTiers:reelTiers).find(t=>t.id===id);
  showToast(`üé£ ${tier.name} equipped!`);
}

function buyItem(item) {
  if (playerMoney < item.price) { showToast('Not enough money!'); return; }
  playerMoney -= item.price;
  if (item.baitId) {
    baitInventory[item.baitId] = (baitInventory[item.baitId]||0) + item.qty;
    const bait = baits.find(b=>b.id===item.baitId);
    showToast(`‚úÖ Bought ${item.label}! (${bait.icon}√ó${item.qty})`);
  } else if (item.bundle) {
    Object.entries(item.bundle).forEach(([bid,qty]) => {
      baitInventory[bid] = (baitInventory[bid]||0) + qty;
    });
    showToast(`‚úÖ Bought ${item.label}!`);
  }
  saveData();
  if(sidePanelOpen&&activeTab==='shop') buildShop(document.getElementById('sp-content'));
  buildBaitBox();
}

// ‚îÄ‚îÄ BAIT BOX ‚îÄ‚îÄ
let baitBoxOpen = false;
let baitBoxStep = 1; // 1=choose bait, 2=choose depth

function toggleBaitBox() {
  playUIClick();
  baitBoxOpen = !baitBoxOpen;
  const bb = document.getElementById('bait-box');
  bb.classList.toggle('open', baitBoxOpen);
  if (baitBoxOpen) { baitBoxStep = 1; buildBaitBox(); }
}

function buildBaitBox() {
  const step1 = document.getElementById('bb-step1');
  const step2 = document.getElementById('bb-step2');
  const baitSec = document.getElementById('bb-bait-section');
  const depthSec = document.getElementById('bb-depth-section');

  if (baitBoxStep === 1) {
    step1.className = 'bb-step active';
    step2.className = 'bb-step';
    baitSec.style.display = 'block';
    depthSec.style.display = 'none';
    const grid = document.getElementById('bait-box-grid');
    grid.innerHTML = '';
    baits.forEach(b => {
      const qty = baitInventory[b.id]||0;
      const btn = document.createElement('button');
      const isLocked = qty === 0;
      btn.className = 'bb-bait' + (selectedBait?.id===b.id?' sel':'') + (isLocked?' locked':'');
      btn.innerHTML = `<span class="bb-bait-icon">${b.icon}</span><span class="bb-bait-name">${b.name}</span><span class="bb-bait-qty">${isLocked?'üö´ BUY':'√ó'+qty}</span>`;
      btn.onclick = () => {
        if(isLocked){showToast(`Buy ${b.name} in the shop first!`);return;}
        selectedBait = b;
        baitBoxStep = 2;
        buildBaitBox();
      };
      grid.appendChild(btn);
    });
  } else {
    step1.className = 'bb-step done';
    step2.className = 'bb-step active';
    baitSec.style.display = 'none';
    depthSec.style.display = 'block';
    const depthRow = document.getElementById('depth-btns');
    depthRow.innerHTML = '';
    depthOptions.forEach(d => {
      const btn = document.createElement('button');
      btn.className = 'bb-depth-btn' + (floatDepth===d.val?' sel':'');
      btn.innerHTML = `<span class="dbi">${d.icon}</span>${d.label}`;
      btn.onclick = () => { floatDepth = d.val; buildBaitBox(); };
      depthRow.appendChild(btn);
    });
  }
  updateStateIndicator();
}

function confirmBaitAndDepth() {
  playUIClick();
  baitBoxOpen = false;
  document.getElementById('bait-box').classList.remove('open');
  updateStateIndicator();
  showToast(`${selectedBait.icon} ${selectedBait.name} ¬∑ ${depthOptions.find(d=>d.val===floatDepth).label} ‚Äî tap water to cast!`);
}
document.addEventListener('click', e => {
  if(baitBoxOpen && !e.target.closest('#bait-box') && !e.target.closest('#fab-baitbox')) {
    baitBoxOpen=false;
    document.getElementById('bait-box').classList.remove('open');
  }
});

function spawnFish() {
  fishList=[];
  const pts=[];
  for(let i=0;i<400;i++){
    const a=Math.random()*Math.PI*2, rx=Math.random()*LAKE_RX*0.90, ry=Math.random()*LAKE_RY*0.90;
    pts.push({x:LAKE_CENTER.x+Math.cos(a)*rx,y:LAKE_CENTER.y+Math.sin(a)*ry});
  }
  for(let i=0;i<28;i++){
    const ft=fishTypes[Math.floor(Math.random()*fishTypes.length)];
    const pos=pts[i%pts.length];
    fishList.push({id:i,...ft,x:pos.x,y:pos.y,depth:ft.depthPref+(Math.random()-0.5)*0.8,
      angle:Math.random()*Math.PI*2,feeding:false,targetX:null,targetY:null,nearBait:false,biteTimer:0,
      tailPhase:Math.random()*Math.PI*2,loiterTimer:0,roamTimer:Math.random()*300,ambushTimer:Math.random()*400});
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AQUARIUM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let aqCanvas,aqCtx,aqAnimId;
let aqFish=[],aqBubbles=[],aqPlants=[],aqPebbles=[],aqPhase=0;

function aqInit() {
  aqCanvas=document.getElementById('aq-canvas');
  aqCtx=aqCanvas.getContext('2d');
  aqResize();
}
function aqResize() {
  if(!aqCanvas)return;
  aqCanvas.width=aqCanvas.offsetWidth; aqCanvas.height=aqCanvas.offsetHeight;
  const W=aqCanvas.width,H=aqCanvas.height;
  aqBuildPlants(W,H); aqBuildBubbles(W,H); aqBuildPebbles(W,H); aqBuildFish(W,H);
}
function aqBuildPlants(W,H) {
  aqPlants=[];
  [0.04,0.10,0.17,0.78,0.86,0.93,0.32,0.50,0.68].forEach(xf=>{
    const n=2+Math.floor(Math.random()*3);
    for(let i=0;i<n;i++) aqPlants.push({x:W*xf+(Math.random()-0.5)*W*0.03,baseY:H-26,height:55+Math.random()*95,leaves:3+Math.floor(Math.random()*4),sway:Math.random()*Math.PI*2,swaySpd:0.010+Math.random()*0.010,hue:110+Math.random()*55,width:2.5+Math.random()*3.5});
  });
}
function aqBuildBubbles(W,H) {
  aqBubbles=[];
  for(let i=0;i<50;i++) aqBubbles.push({x:Math.random()*W,y:Math.random()*H,r:1.2+Math.random()*3.2,speed:0.25+Math.random()*0.55,drift:Math.random()*Math.PI*2,driftSpd:0.025+Math.random()*0.025});
}
function aqBuildPebbles(W,H) {
  aqPebbles=[];
  for(let x=4;x<W;x+=8+Math.random()*6) aqPebbles.push({x,y:H-22+(Math.random()-0.5)*10,rx:3+Math.random()*5,ry:2+Math.random()*3,h:Math.round(40+Math.random()*35)});
}
function aqBuildFish(W,H) {
  aqFish=aquariumFish.map(af=>{
    const ft=fishTypes.find(t=>t.type===af.type)||{size:14,color:'#4488aa'};
    return {type:af.type,weight:af.weight,size:ft.size*1.35,color:ft.color,x:W*0.15+Math.random()*W*0.70,y:H*0.18+Math.random()*H*0.55,vx:(Math.random()-0.5)*1.2,vy:(Math.random()-0.5)*0.5,tailPhase:Math.random()*Math.PI*2,flipX:1,targetX:W*0.1+Math.random()*W*0.8,targetY:H*0.15+Math.random()*H*0.60,waitTimer:0};
  });
}

function showAquarium() {
  document.getElementById('aquarium-screen').classList.add('show');
  gameState='aquarium';
  updateSideBtns();
  const coll=document.getElementById('aq-collection'),empty=document.getElementById('aq-empty-hint');
  coll.innerHTML='';
  if(aquariumFish.length===0){empty.style.display='block';}
  else{
    empty.style.display='none';
    aquariumFish.forEach((af,i)=>{
      const ft=fishTypes.find(t=>t.type===af.type)||{emoji:'üêü'};
      const pill=document.createElement('div');
      pill.className='aq-pill'; pill.style.animationDelay=`${i*60}ms`;
      pill.innerHTML=`<span class="aq-pill-emoji">${ft.emoji}</span>${af.type}<span class="aq-pill-wt">${af.weight}g</span>`;
      coll.appendChild(pill);
    });
  }
  aqInit(); aqResize();
  if(aqAnimId) cancelAnimationFrame(aqAnimId);
  const loop=()=>{ if(gameState!=='aquarium')return; aqUpdate(); aqDraw(); aqAnimId=requestAnimationFrame(loop); };
  loop();
}
function aqStop(){if(aqAnimId){cancelAnimationFrame(aqAnimId);aqAnimId=null;}}

function startFishing() {
  aqStop();
  document.getElementById('aquarium-screen').classList.remove('show');
  gameState='peg-selection';
  resetView();
  updateSideBtns();
  updateStateIndicator();
  showToast('Click a peg to start fishing!');
}

function aqUpdate() {
  if(!aqCanvas)return;
  const W=aqCanvas.width,H=aqCanvas.height;
  aqPhase+=0.028;
  aqPlants.forEach(p=>{p.sway+=p.swaySpd;});
  aqBubbles.forEach(b=>{b.drift+=b.driftSpd;b.x+=Math.sin(b.drift)*0.4;b.y-=b.speed;if(b.y<-8){b.y=H+5;b.x=Math.random()*W;}});
  aqFish.forEach(f=>{
    f.tailPhase+=0.09;
    if(f.waitTimer>0){f.waitTimer--;return;}
    const dx=f.targetX-f.x,dy=f.targetY-f.y,d=Math.hypot(dx,dy),spd=0.7+f.size*0.012;
    if(d>8){
      f.vx+=(dx/d)*0.08; f.vy+=(dy/d)*0.05; f.vx*=0.92; f.vy*=0.92;
      const mag=Math.hypot(f.vx,f.vy);
      if(mag>spd){f.vx=f.vx/mag*spd;f.vy=f.vy/mag*spd;}
      f.x+=f.vx;f.y+=f.vy;
      if(f.vx!==0)f.flipX=f.vx>0?1:-1;
    } else {
      f.waitTimer=40+Math.floor(Math.random()*120);
      f.targetX=W*0.08+Math.random()*W*0.84;
      f.targetY=H*0.12+Math.random()*H*0.62;
      f.vx*=0.5;f.vy*=0.5;
    }
    f.x=Math.max(f.size*2,Math.min(W-f.size*2,f.x));
    f.y=Math.max(H*0.07,Math.min(H-55,f.y));
  });
}

function aqDraw() {
  if(!aqCtx||!aqCanvas)return;
  const c=aqCtx,W=aqCanvas.width,H=aqCanvas.height;
  const bg=c.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'#08162a'); bg.addColorStop(0.45,'#0b2040'); bg.addColorStop(0.85,'#0d2848'); bg.addColorStop(1,'#091828');
  c.fillStyle=bg; c.fillRect(0,0,W,H);
  c.save();
  for(let i=0;i<8;i++){
    const cx=(i/7)*W+Math.sin(aqPhase*0.3+i*0.9)*W*0.06,rw=15+Math.sin(aqPhase*0.5+i*1.3)*10;
    const ray=c.createLinearGradient(0,0,0,H*0.55),alpha=0.025+0.015*Math.sin(aqPhase*0.7+i);
    ray.addColorStop(0,`rgba(56,200,220,${alpha})`); ray.addColorStop(1,'rgba(56,200,220,0)');
    c.fillStyle=ray; c.beginPath(); c.moveTo(cx-rw*0.5,0); c.lineTo(cx+rw*0.5,0); c.lineTo(cx+rw*2.5,H*0.55); c.lineTo(cx-rw*2.5,H*0.55); c.closePath(); c.fill();
  }
  c.restore();
  aqPlants.forEach(p=>aqDrawPlant(c,p));
  const grav=c.createLinearGradient(0,H-36,0,H); grav.addColorStop(0,'#261a0e'); grav.addColorStop(1,'#140e06');
  c.fillStyle=grav; c.fillRect(0,H-36,W,36);
  aqPebbles.forEach(p=>{c.fillStyle=`rgb(${p.h+8},${p.h},${p.h-8})`;c.beginPath();c.ellipse(p.x,p.y,p.rx,p.ry,0,0,Math.PI*2);c.fill();});
  aqBubbles.forEach(b=>{c.save();c.globalAlpha=0.25+0.15*Math.sin(b.drift);c.strokeStyle='rgba(160,235,255,0.7)';c.lineWidth=0.8;c.beginPath();c.arc(b.x,b.y,b.r,0,Math.PI*2);c.stroke();c.globalAlpha=0.35;c.fillStyle='rgba(210,245,255,0.5)';c.beginPath();c.arc(b.x-b.r*0.3,b.y-b.r*0.3,b.r*0.32,0,Math.PI*2);c.fill();c.restore();});
  aqFish.forEach(f=>{
    c.save();c.translate(f.x,f.y);
    c.save();c.translate(0,(H-40)-f.y);c.globalAlpha=0.07;c.fillStyle='#000';c.beginPath();c.ellipse(0,0,f.size*1.1,f.size*0.28,0,0,Math.PI*2);c.fill();c.restore();
    c.scale(f.flipX,1); aqDrawFish(c,f); c.scale(f.flipX,1);
    c.globalAlpha=0.45;c.fillStyle='#c8f0e8';c.font=`bold ${Math.round(f.size*0.52)}px Nunito,sans-serif`;c.textAlign='center';c.textBaseline='bottom';c.fillText(f.type,0,-f.size*1.15);c.restore();
  });
  c.save();const surf=c.createLinearGradient(0,0,0,22);surf.addColorStop(0,'rgba(56,210,225,0.18)');surf.addColorStop(1,'rgba(56,210,225,0)');c.fillStyle=surf;c.fillRect(0,0,W,22);c.restore();
  const leftG=c.createLinearGradient(0,0,16,0);leftG.addColorStop(0,'rgba(180,240,255,0.10)');leftG.addColorStop(1,'rgba(180,240,255,0)');c.fillStyle=leftG;c.fillRect(0,0,16,H);
  c.strokeStyle='rgba(56,217,192,0.15)';c.lineWidth=3;c.strokeRect(1.5,1.5,W-3,H-3);
}

function aqDrawPlant(c,p) {
  const sw=Math.sin(p.sway)*7;
  c.save();c.translate(p.x,p.baseY);c.lineCap='round';
  c.strokeStyle=`hsl(${p.hue},52%,26%)`;c.lineWidth=p.width;c.beginPath();c.moveTo(0,0);c.bezierCurveTo(sw*0.3,-p.height*0.35,sw*0.7,-p.height*0.65,sw,-p.height);c.stroke();
  for(let l=0;l<p.leaves;l++){
    const t=(l+1)/(p.leaves+1),lx=sw*t,ly=-p.height*t,side=(l%2===0)?1:-1,len=16+Math.sin(l*2.1)*12,ang=side*(0.35+Math.sin(p.sway*0.6+l)*0.1);
    c.save();c.translate(lx,ly);c.rotate(ang);c.beginPath();c.moveTo(0,0);c.bezierCurveTo(len*0.35,-len*0.28,len*0.78,-len*0.1,len,0);c.bezierCurveTo(len*0.78,len*0.10,len*0.35,len*0.22,0,0);
    c.fillStyle=`hsla(${p.hue+8},58%,${28+Math.sin(p.sway+l)*5}%,0.88)`;c.fill();c.strokeStyle=`hsla(${p.hue},48%,20%,0.5)`;c.lineWidth=0.6;c.stroke();c.restore();
  }
  c.beginPath();c.arc(sw,-p.height,p.width,0,Math.PI*2);c.fillStyle=`hsl(${p.hue+18},62%,42%)`;c.fill();c.restore();
}

function aqDrawFish(c,f) {
  const s=f.size,tw=Math.sin(f.tailPhase)*0.38;
  c.save();c.translate(-s*0.82,0);c.rotate(tw);c.beginPath();c.moveTo(0,0);c.lineTo(-s*0.62,-s*0.5);c.lineTo(-s*0.62,s*0.5);c.closePath();c.fillStyle=darken(f.color,18);c.fill();c.restore();
  const bg=c.createRadialGradient(s*0.1,-s*0.15,s*0.1,0,0,s);bg.addColorStop(0,lighten(f.color,45));bg.addColorStop(0.5,f.color);bg.addColorStop(1,darken(f.color,25));
  c.beginPath();c.ellipse(0,0,s,s*0.44,0,0,Math.PI*2);c.fillStyle=bg;c.fill();c.strokeStyle=darken(f.color,30);c.lineWidth=0.8;c.stroke();
  c.beginPath();c.moveTo(-s*0.1,-s*0.44);c.lineTo(-s*0.1,-s*0.75);c.lineTo(s*0.35,-s*0.44);c.fillStyle=`${f.color}99`;c.fill();
  c.beginPath();c.ellipse(s*0.15,s*0.2,s*0.22,s*0.09,0.3,0,Math.PI*2);c.fillStyle=`${f.color}88`;c.fill();
  c.beginPath();c.arc(s*0.54,-s*0.12,s*0.13,0,Math.PI*2);c.fillStyle='#ddd';c.fill();
  c.beginPath();c.arc(s*0.54,-s*0.12,s*0.08,0,Math.PI*2);c.fillStyle='#111';c.fill();
  c.beginPath();c.arc(s*0.56,-s*0.14,s*0.03,0,Math.PI*2);c.fillStyle='rgba(255,255,255,0.8)';c.fill();
}

function updateAquariumDisplay() { if(gameState==='aquarium') showAquarium(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE INDICATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStateIndicator() {
  const el = document.getElementById('state-indicator');
  const map = {
    'peg-selection': 'üìç Click a peg to start',
    'bait-menu':     selectedBait ? `üéí ${selectedBait.icon} ${selectedBait.name} ‚Äî tap CAST` : 'üéí Choose bait then CAST',
    'aiming':        'üéØ Tap CAST to lock angle',
    'power':         '‚ö° Tap CAST to release',
    'fishing':       'üé£ Waiting for a bite...',
    'fish-hooked':   'üêü FISH ON! Hold REEL to bring it in!',
  };
  const txt = map[gameState];
  if(txt && gameState !== 'aquarium') {
    el.textContent = txt;
    el.classList.add('show');
  } else {
    el.classList.remove('show');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg,dur=2500) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),dur);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetView() {
  const vp=document.getElementById('viewport');
  const vpW=vp.clientWidth,vpH=vp.clientHeight;
  viewScale=Math.min(vpW/WORLD_W,vpH/WORLD_H)*0.85;
  viewX=(vpW-WORLD_W*viewScale)/2;
  viewY=(vpH-WORLD_H*viewScale)/2;
  applyTransform();
}
function adjustZoom(delta) {
  const vp=document.getElementById('viewport');
  const cx=vp.clientWidth/2,cy=vp.clientHeight/2,prev=viewScale;
  viewScale=Math.max(0.25,Math.min(3,viewScale+delta));
  viewX=cx-(cx-viewX)*(viewScale/prev); viewY=cy-(cy-viewY)*(viewScale/prev);
  applyTransform();
}
function applyTransform() { canvas.style.transform=`translate(${viewX}px,${viewY}px) scale(${viewScale})`; }
function canvasToWorld(clientX,clientY) {
  const vp=document.getElementById('viewport'),rect=vp.getBoundingClientRect();
  return {x:(clientX-rect.left-viewX)/viewScale,y:(clientY-rect.top-viewY)/viewScale};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bindInput() {
  const vp=document.getElementById('viewport');
  vp.addEventListener('mousedown',e=>{
    if(e.button!==0)return;
    isDragging=false; dragStartX=e.clientX; dragStartY=e.clientY; dragViewX=viewX; dragViewY=viewY;
    vp.addEventListener('mousemove',onMM); vp.addEventListener('mouseup',onMU,{once:true});
  });
  function onMM(e){const dx=e.clientX-dragStartX,dy=e.clientY-dragStartY;if(Math.abs(dx)>4||Math.abs(dy)>4){isDragging=true;viewX=dragViewX+dx;viewY=dragViewY+dy;applyTransform();}}
  function onMU(e){vp.removeEventListener('mousemove',onMM);if(!isDragging)handleWorldClick(e.clientX,e.clientY);isDragging=false;}

  vp.addEventListener('wheel',e=>{
    e.preventDefault();
    const rect=vp.getBoundingClientRect(),cx=e.clientX-rect.left,cy=e.clientY-rect.top,prev=viewScale;
    viewScale=Math.max(0.25,Math.min(3,viewScale-e.deltaY*0.001));
    viewX=cx-(cx-viewX)*(viewScale/prev); viewY=cy-(cy-viewY)*(viewScale/prev);
    applyTransform();
  },{passive:false});

  let pinchSD=0,pinchSS=1,pinchMX=0,pinchMY=0,pinchVX=0,pinchVY=0;
  let tpan=false,tsx,tsy,tvx,tvy,tmov=false;
  vp.addEventListener('touchstart',e=>{
    e.preventDefault();
    if(e.touches.length===2){
      tpan=false;const t1=e.touches[0],t2=e.touches[1];
      pinchSD=Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY); pinchSS=viewScale;
      pinchMX=(t1.clientX+t2.clientX)/2; pinchMY=(t1.clientY+t2.clientY)/2; pinchVX=viewX; pinchVY=viewY;
    }else{tpan=true;tsx=e.touches[0].clientX;tsy=e.touches[0].clientY;tvx=viewX;tvy=viewY;tmov=false;}
  },{passive:false});
  vp.addEventListener('touchmove',e=>{
    e.preventDefault();
    if(e.touches.length===2){
      const t1=e.touches[0],t2=e.touches[1],dist=Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY);
      const mx=(t1.clientX+t2.clientX)/2,my=(t1.clientY+t2.clientY)/2,prev=viewScale;
      viewScale=Math.max(0.25,Math.min(3,pinchSS*dist/pinchSD));
      viewX=mx-(pinchMX-pinchVX)*(viewScale/pinchSS); viewY=my-(pinchMY-pinchVY)*(viewScale/pinchSS); applyTransform();
    }else if(tpan){const dx=e.touches[0].clientX-tsx,dy=e.touches[0].clientY-tsy;if(Math.abs(dx)>5||Math.abs(dy)>5)tmov=true;viewX=tvx+dx;viewY=tvy+dy;applyTransform();}
  },{passive:false});
  vp.addEventListener('touchend',e=>{
    e.preventDefault();
    if(e.changedTouches.length===1&&tpan&&!tmov){const t=e.changedTouches[0];handleWorldClick(t.clientX,t.clientY);}
  },{passive:false});
}

function handleWorldClick(clientX,clientY) {
  ensureAudio();
  const w=canvasToWorld(clientX,clientY);
  if(gameState==='fish-hooked')return;

  // Peg selection ‚Äî always allow switching peg if no bait chosen yet
  if(gameState==='peg-selection'||(gameState==='bait-menu'&&!selectedBait)){
    let hitPeg=false;
    pegs.forEach(peg=>{
      const d=Math.hypot(w.x-peg.x,w.y-peg.y);
      if(d<30){selectedPeg=peg.id;gameState='bait-menu';hitPeg=true;updateSideBtns();updateStateIndicator();showToast(`Peg ${peg.id} ‚Äî pick your bait then tap to cast!`);}
    });
    return;
  }

  // Bait chosen + peg selected: tap anywhere starts casting
  if(gameState==='bait-menu'&&selectedBait){
    // Allow peg switching with a direct peg tap even now
    let hitPeg=false;
    pegs.forEach(peg=>{
      const d=Math.hypot(w.x-peg.x,w.y-peg.y);
      if(d<30){selectedPeg=peg.id;hitPeg=true;updateSideBtns();updateStateIndicator();showToast(`Switched to Peg ${peg.id}! Tap again to cast.`);}
    });
    if(!hitPeg){ handleCast(); }
    return;
  }

  if(gameState==='aiming'){gameState='power';powerLevel=0;powerDir=1;updateSideBtns();updateStateIndicator();return;}
  if(gameState==='power'){execCast();return;}
}

function bindReelTap() {
  const vp=document.getElementById('viewport');
  function startReel(e){
    if(e.target.closest('#side-btns'))return;
    if(gameState==='fish-hooked'){ensureAudio();isReeling=true;updateSideBtns();}
    else if(gameState==='fishing'&&floatPos&&!castSinking){ensureAudio();isReelIn=true;}
  }
  function stopReel(e){if(gameState==='fish-hooked'){isReeling=false;updateSideBtns();}isReelIn=false;}
  vp.addEventListener('mousedown',startReel); vp.addEventListener('mouseup',stopReel); vp.addEventListener('mouseleave',stopReel);
  vp.addEventListener('touchstart',startReel,{passive:true}); vp.addEventListener('touchend',stopReel); vp.addEventListener('touchcancel',stopReel);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CAST / FISHING ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleCast() {
  if(!selectedBait){showToast('Pick a bait first! (tap BAITS)');return;}
  const qty=baitInventory[selectedBait.id]||0;
  if(qty<=0){showToast(`No ${selectedBait.name} left! Visit the SHOP.`);selectedBait=null;updateStateIndicator();return;}
  gameState='aiming'; angleSweep=0; sweepDir=1;
  updateSideBtns(); updateStateIndicator();
  showToast('üéØ Tap CAST to lock your angle');
}

function throwGroundBait() {
  if(!floatPos){showToast('Cast first!');return;}
  if(groundBaitStock>0){
    groundBaitStock--;
    saveData();
  } else {
    if(playerMoney<5){showToast('Need $5 for ground bait!');return;}
    playerMoney-=5; saveData();
  }
  const spread=140;
  for(let i=0;i<6;i++) groundBait.push({x:floatPos.x+(Math.random()-0.5)*spread,y:floatPos.y+(Math.random()-0.5)*spread,depth:floatDepth,baitId:selectedBait?selectedBait.id:'pellet',sinkT:0,settled:false});
  const freeLeft = groundBaitStock > 0 ? ` (${groundBaitStock} free left)` : ' (-$5)';
  showToast(`ü™£ Ground bait thrown!${freeLeft}`);
  updateSideBtns();
}

function toggleDebug() {
  debugMode=!debugMode;
  document.getElementById('btn-debug').classList.toggle('on',debugMode);
}

function updateSideBtns() {
  const el=document.getElementById('side-btns');
  const fabCast=document.getElementById('fab-cast');
  const fabCastIcon=document.getElementById('fab-cast-icon');
  const fabCastLbl=document.getElementById('fab-cast-label');
  const fabBaitBox=document.getElementById('fab-baitbox');
  const fabReel=document.getElementById('fab-reel');
  const fabGb=document.getElementById('fab-gb');
  const fabSep=document.getElementById('fab-sep1');
  const fabIcon=document.getElementById('fab-reel-icon');
  const fabLbl=document.getElementById('fab-reel-label');

  const showSide=['bait-menu','aiming','power','fishing','fish-hooked'].includes(gameState);
  el.classList.toggle('show',showSide);

  if(!showSide){
    baitBoxOpen=false;
    document.getElementById('bait-box').classList.remove('open');
    return;
  }

  const inCasting = ['bait-menu','aiming','power'].includes(gameState);
  const inFishing = gameState==='fishing';
  const inFight   = gameState==='fish-hooked';

  fabCast.style.display = inCasting ? 'flex' : 'none';
  if(gameState==='bait-menu'){
    fabCastIcon.textContent='üéØ'; fabCastLbl.textContent='CAST';
  } else if(gameState==='aiming'){
    fabCastIcon.textContent='üìê'; fabCastLbl.textContent='LOCK';
  } else if(gameState==='power'){
    fabCastIcon.textContent='‚ö°'; fabCastLbl.textContent='RELEASE';
  }

  fabBaitBox.style.display = (gameState==='bait-menu') ? 'flex' : 'none';
  fabSep.style.display = inFishing ? 'block' : 'none';
  fabReel.style.display = (inFishing||inFight) ? 'flex' : 'none';
  fabGb.style.display = inFishing ? 'flex' : 'none';

  if(inFishing){
    const gbLabel = groundBaitStock>0 ? `BAIT <span style="font-size:0.55rem;color:#ffe080">√ó${groundBaitStock}</span>` : `BAIT <span style="font-size:0.55rem;opacity:0.8">$5</span>`;
    fabGb.innerHTML = `<span class="fab-icon">ü™£</span>${gbLabel}`;
    fabGb.onclick = throwGroundBait;
  }

  if(inFight){
    const danger = fishRunning && isReeling;
    const sweetMode = sweetSpotInZone && isReeling && !fishRunning;
    fabReel.classList.toggle('danger', danger);
    fabReel.classList.toggle('reeling', isReeling && !danger);
    if (sweetMode) {
      fabIcon.textContent = '‚≠ê';
      fabLbl.textContent = 'SWEET SPOT!';
    } else if (danger) {
      fabIcon.textContent = '‚ö†Ô∏è';
      fabLbl.textContent = 'RELEASE!';
    } else if (isReeling) {
      fabIcon.textContent = 'üé£';
      fabLbl.textContent = 'REELING';
    } else if (fishRunning) {
      fabIcon.textContent = 'üèÉ';
      fabLbl.textContent = 'WAIT...';
    } else {
      fabIcon.textContent = 'üîÑ';
      fabLbl.textContent = 'HOLD REEL';
    }
  } else {
    fabReel.classList.remove('danger','reeling');
    fabIcon.textContent='üîÑ'; fabLbl.textContent='REEL IN';
  }

  // Update DOM tension bar
  updateTensionHUD();
}

function handleFabCast() {
  ensureAudio(); playUIClick();
  if(gameState==='bait-menu'){handleCast();return;}
  if(gameState==='aiming'){gameState='power';powerLevel=0;powerDir=1;updateSideBtns();updateStateIndicator();return;}
  if(gameState==='power'){execCast();return;}
}

function execCast() {
  if(selectedBait){
    baitInventory[selectedBait.id]=Math.max(0,(baitInventory[selectedBait.id]||0)-1);
    saveData();
  }
  const peg=pegs.find(p=>p.id===selectedPeg);
  const faceAngle=pegFacingAngle(peg);
  const sweepRad=(faceAngle+angleSweep)*Math.PI/180;
  const rod=getActiveRod();
  const dist=(powerLevel/100)*700*rod.castMult+50;
  floatPos={x:peg.x+Math.cos(sweepRad)*dist,y:peg.y+Math.sin(sweepRad)*dist};
  castLine={x1:peg.x,y1:peg.y,x2:floatPos.x,y2:floatPos.y};
  castSinking=true; sinkProgress=0;
  bobDriftX=0; bobDriftY=0; bobDriftAngle=Math.random()*Math.PI*2;
  gameState='fishing';
  playCastWhoosh(); playSplash(); addRipple(floatPos.x,floatPos.y);
  updateSideBtns(); updateStateIndicator();
  showToast(`Cast! Waiting for a bite... (${selectedBait?selectedBait.icon+' √ó'+(baitInventory[selectedBait.id]||0):''})`);
}

function fabReelDown(e) { e.preventDefault(); ensureAudio(); isReeling=true; updateSideBtns(); }
function fabReelUp(e) { e.preventDefault(); isReeling=false; updateSideBtns(); }

// Sweet-spot phase ‚Äî the ideal tension zone drifts over time

function updateTensionHUD() {
  const hud = document.getElementById('tension-hud');
  const fill = document.getElementById('tension-fill');
  const warn = document.getElementById('tension-warn');
  const staminaFill = document.getElementById('stamina-fill');
  const inFight = gameState === 'fish-hooked';
  hud.classList.toggle('show', inFight);
  if (!inFight) return;

  const reel = getActiveReel();
  const pct = Math.min(100, Math.round((tension / reel.tensionMax) * 100));
  fill.style.width = pct + '%';
  fill.setAttribute('data-pct', pct + '%');

  // Tension danger state
  const danger = pct > 75;
  hud.classList.toggle('danger', danger);

  // Stamina bar ‚Äî reversed: green=full, red=empty
  const stamPct = Math.max(0, fishStamina);
  staminaFill.style.width = stamPct + '%';
  // Stamp bar color driven by position on gradient
  const stamFraction = stamPct / 100;
  const stamBackgroundPos = ((1 - stamFraction) * 380) + 'px 0';
  staminaFill.style.backgroundPosition = stamBackgroundPos;

  // Fish name & phase
  const fishNameEl = document.getElementById('fight-fish-name');
  if (hookedFish) fishNameEl.textContent = (hookedFish.emoji || 'üêü') + ' ' + hookedFish.type.toUpperCase();

  const phaseBadge = document.getElementById('fight-phase-badge');
  if (fishStamina > 60) {
    phaseBadge.className = 'fresh'; phaseBadge.textContent = 'üí™ FRESH';
  } else if (fishStamina > 25) {
    phaseBadge.className = 'tiring'; phaseBadge.textContent = 'üò§ TIRING';
  } else {
    phaseBadge.className = 'exhausted'; phaseBadge.textContent = 'üòµ EXHAUSTED';
  }

  // Status banner
  const banner = document.getElementById('fight-status-banner');
  const dangerRun = fishRunning && isReeling;
  if (dangerRun) {
    banner.className = 'danger-run'; banner.textContent = '‚ö†Ô∏è RUNNING ‚Äî RELEASE REEL or line SNAPS!';
  } else if (fishRunning) {
    banner.className = 'running'; banner.textContent = 'üèÉ FISH RUNNING ‚Äî Wait for it to tire...';
  } else if (isReeling) {
    banner.className = 'reeling'; banner.textContent = 'üîÑ REELING IN ‚Äî Keep holding!';
  } else {
    banner.className = 'resting'; banner.textContent = 'üí§ RESTING ‚Äî Hold REEL button to bring it in!';
  }

  // Sweet-spot drift
  sweetSpotPos += sweetSpotDir * 0.18;
  if (sweetSpotPos > 72 || sweetSpotPos < 10) sweetSpotDir *= -1;
  sweetSpotPos = Math.max(8, Math.min(74, sweetSpotPos));
  const ss = document.getElementById('sweet-spot');
  ss.style.left = sweetSpotPos + '%';
  // Glow when tension is in sweet zone
  const wasInZone = sweetSpotInZone;
  sweetSpotInZone = (pct >= sweetSpotPos && pct <= sweetSpotPos + 18);
  // Play a soft chime when entering the sweet zone
  if (sweetSpotInZone && !wasInZone && isReeling && !fishRunning) {
    playTone(880, 'sine', 0.12, 0.08);
    setTimeout(()=>playTone(1320, 'sine', 0.10, 0.06), 80);
  }
  ss.style.background = sweetSpotInZone
    ? 'rgba(109,219,74,0.45)' : 'rgba(109,219,74,0.18)';
  ss.style.boxShadow = sweetSpotInZone ? '0 0 12px rgba(109,219,74,0.5)' : 'none';

  // Tug indicator
  const tug = document.getElementById('tug-indicator');
  if (isReeling && !fishRunning) { tug.className='active-reel'; }
  else if (fishRunning) { tug.className='active-run'; }
  else { tug.className=''; }

  // Rod bend icon
  const rodIcon = document.getElementById('rod-bend-icon');
  const bendDeg = Math.min(45, pct * 0.45);
  rodIcon.style.transform = `rotate(${bendDeg}deg)`;
  rodIcon.style.filter = pct > 75 ? `drop-shadow(0 0 8px rgba(240,69,69,0.8))` : `drop-shadow(0 0 4px rgba(56,217,192,0.4))`;

  // Warning text
  warn.textContent = pct >= 90 ? '‚ö† ABOUT TO SNAP ‚Äî RELEASE REEL NOW!' : (pct > 75 ? '‚ö† HIGH TENSION ‚Äî ease off!' : sweetSpotInZone ? '‚úÖ SWEET SPOT ‚Äî Keep reeling!' : '');
  warn.style.color = pct >= 90 ? '#ff3030' : pct > 75 ? '#f07830' : '#6ddb4a';
}

// ‚îÄ‚îÄ Journal & Encyc -- now handled by unified panel (shims above)
function buildJournal(el) {
  if (!el) el = document.getElementById('sp-content');

  // Summary stats bar
  const totalCaught=Object.values(speciesRecords).reduce((a,b)=>a+b.count,0);
  const speciesSeen=Object.keys(speciesRecords).length;
  const bestFish=Object.entries(speciesRecords).sort((a,b)=>b[1].bestWeight-a[1].bestWeight)[0];
  const bar=document.createElement('div');
  bar.className='journal-stats-bar';
  bar.innerHTML=`
    <div class="journal-stat-tile"><div class="jst-val">${totalCaught}</div><div class="jst-lbl">Total Caught</div></div>
    <div class="journal-stat-tile"><div class="jst-val">${speciesSeen}/${fishTypes.length}</div><div class="jst-lbl">Species</div></div>
    <div class="journal-stat-tile"><div class="jst-val">${bestFish?bestFish[1].bestWeight+'g':'‚Äî'}</div><div class="jst-lbl">Best Weight</div></div>
  `;
  el.appendChild(bar);

  // Species records
  const recLbl=document.createElement('div');recLbl.className='journal-section-lbl';recLbl.textContent='üèÜ Species Records';el.appendChild(recLbl);
  fishTypes.forEach(ft=>{
    const rec=speciesRecords[ft.type];
    const card=document.createElement('div');
    card.className='journal-record-card'+(rec?' has-record':'');
    card.innerHTML=`
      <div class="journal-record-emoji">${ft.emoji}</div>
      <div class="journal-record-info">
        <div class="journal-record-name">${ft.type}</div>
        ${rec
          ? `<div class="journal-record-best">üèÜ ${rec.bestWeight}g ¬∑ ${rec.bestSize}cm</div><div class="journal-record-count">Caught ${rec.count}√ó</div>`
          : `<div class="journal-record-count" style="color:var(--muted);opacity:0.5">Not yet caught</div>`}
      </div>
      ${rec?`<div class="journal-record-badge">#${rec.count}</div>`:''}
    `;
    el.appendChild(card);
  });

  // Recent catches log
  if(catchLog.length>0){
    const logLbl=document.createElement('div');logLbl.className='journal-section-lbl';logLbl.textContent='üìã Recent Catches';el.appendChild(logLbl);
    const listDiv=document.createElement('div');listDiv.className='journal-entry-list';
    [...catchLog].reverse().slice(0,20).forEach(entry=>{
      const div=document.createElement('div');div.className='journal-entry';
      div.innerHTML=`<div class="journal-entry-emoji">${entry.emoji}</div><div class="journal-entry-info"><b>${entry.type}</b> ‚Äî ${entry.weight}g ¬∑ ${entry.size}cm</div><div class="journal-entry-time">‚è± ${entry.gameTimeStr}</div>`;
      listDiv.appendChild(div);
    });
    el.appendChild(listDiv);
  } else {
    const empty=document.createElement('div');empty.className='journal-empty';empty.innerHTML='<div style="font-size:2rem;margin-bottom:8px">üé£</div>No catches recorded yet.<br>Get out there and fish!';el.appendChild(empty);
  }
}
function buildEncyc(el) {
  if (!el) el = document.getElementById('sp-content');
  fishTypes.forEach(ft=>{
    const depthOffset=Math.max(0,((ft.depthPref-1)/2)*70);
    const card=document.createElement('div');
    card.className='ep-fish-card';
    const chips=baits.map(b=>{
      const isFav=b.id===ft.favBait,isOk=ft.okBaits.includes(b.id);
      if(!isFav&&!isOk)return'';
      return`<div class="ep-bait-chip${isFav?' fav':''}">${isFav?'<span class="chip-star">‚òÖ</span>':''}${b.icon} ${b.name}</div>`;
    }).join('');
    card.innerHTML=`<div class="ep-fish-top"><div class="ep-fish-emoji">${ft.emoji}</div><div class="ep-fish-meta"><div class="ep-fish-name">${ft.type.toUpperCase()}</div><div class="ep-fish-latin">${ft.latin}</div></div><div class="ep-price-badge">$${ft.basePrice}</div></div>
    <div class="ep-divider"></div><div class="ep-stats-row"><div class="ep-stat"><div class="ep-stat-lbl">Max Wt</div><div class="ep-stat-val">${ft.baseWeight}g</div></div><div class="ep-stat"><div class="ep-stat-lbl">Length</div><div class="ep-stat-val">~${ft.size}cm</div></div><div class="ep-stat"><div class="ep-stat-lbl">Speed</div><div class="ep-stat-val">${ft.speed<0.17?'Slow':ft.speed<0.23?'Med':'Fast'}</div></div></div>
    <div class="ep-divider"></div><div class="ep-depth-section"><div class="ep-section-lbl">Preferred Depth</div><div class="ep-depth-vis"><div class="ep-depth-track"><div class="ep-depth-fill" style="width:28%;margin-left:${depthOffset}%"></div></div><div class="ep-depth-label">${ft.depthLabel}</div></div></div>
    <div class="ep-bait-section"><div class="ep-section-lbl">Bait <span style="color:var(--gold);font-size:0.55rem">‚òÖ=FAV</span></div><div class="ep-bait-chips">${chips||'<span style="color:var(--muted);font-size:0.7rem">Rarely bites</span>'}</div></div>`;
    el.appendChild(card);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FISH HOOKING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê













































function hookFish(f) {
  playHookUp();
  hookedFish=f; gameState='fish-hooked'; fishRunning=true;
  runTimer=3000+Math.random()*4000+f.size*80;
  tension=0; lineHealth=100; isReeling=false;
  fishStamina=100; reelVelocity=0;
  sweetSpotPos = 20 + Math.random()*40;  // randomise starting position
  sweetSpotDir = Math.random() > 0.5 ? 1 : -1;
  const peg=pegs.find(p=>p.id===selectedPeg);
  hookedFish.angle=Math.atan2(f.y-peg.y,f.x-peg.x)+(Math.random()-0.5)*0.5;
  updateSideBtns(); updateStateIndicator();
  showToast('üé£ BITE! Hold REEL to reel in ‚Äî release if running!',3500);
}

function catchFish() {
  playLanding();
  gameState = 'catch-modal'; // prevent re-entry and hide fight HUDs
  document.getElementById('dist-hud').className='';
  document.getElementById('tension-hud').classList.remove('show');
  updateSideBtns();
  const weight=Math.round(hookedFish.baseWeight*(0.6+Math.random()*0.8));
  const size=Math.round(hookedFish.size*(0.8+Math.random()*0.4));
  const price=Math.round(hookedFish.basePrice*(weight/hookedFish.baseWeight));
  caughtFish={type:hookedFish.type,weight,size,color:hookedFish.color,emoji:hookedFish.emoji,price,latin:fishTypes.find(f=>f.type===hookedFish.type)?.latin||''};
  catchLog.push({type:caughtFish.type,weight,size,emoji:caughtFish.emoji,gameTimeStr:getGameTimeStr(),timestamp:Date.now()});
  if(!speciesRecords[caughtFish.type]){
    speciesRecords[caughtFish.type]={bestWeight:weight,bestSize:size,count:1};
  } else {
    const rec=speciesRecords[caughtFish.type];
    rec.count++;
    if(weight>rec.bestWeight){rec.bestWeight=weight;rec.bestSize=size;}
  }
  saveData();
  showCatchModal();
}

let _catchAnimId = null;

function showCatchModal() {
  const rec = speciesRecords[caughtFish.type];
  const isNewSpecies = rec && rec.count === 1;
  const isPB = rec && !isNewSpecies && caughtFish.weight >= rec.bestWeight;

  document.getElementById('modal-name').textContent = caughtFish.type.toUpperCase();
  document.getElementById('modal-latin').textContent = caughtFish.latin || '';
  document.getElementById('catch-weight').textContent = caughtFish.weight + 'g';
  document.getElementById('catch-size').textContent = caughtFish.size + 'cm';
  document.getElementById('catch-value').textContent = '$' + caughtFish.price;
  document.getElementById('release-value').textContent = '$' + caughtFish.price;

  const pbBadge = document.getElementById('catch-pb-badge');
  if (isNewSpecies) { pbBadge.textContent = 'üèÜ NEW SPECIES!'; pbBadge.style.display = 'block'; }
  else if (isPB)    { pbBadge.textContent = 'üèÜ PERSONAL BEST!'; pbBadge.style.display = 'block'; }
  else              { pbBadge.style.display = 'none'; }

  const pbRow = document.getElementById('catch-pb-row');
  pbRow.innerHTML = (rec && rec.count > 1)
    ? `PB: <span>${rec.bestWeight}g</span> &nbsp;¬∑&nbsp; Caught: <span>${rec.count}√ó</span>` : '';

  document.getElementById('modal').classList.add('show');

  // Cancel any previous animation
  if (_catchAnimId) { cancelAnimationFrame(_catchAnimId); _catchAnimId = null; }

  const fishCanvas = document.getElementById('catch-fish-canvas');
  const fctx = fishCanvas.getContext('2d');
  const ft = fishTypes.find(f => f.type === caughtFish.type);
  const fishSize = ft ? ft.size * 2.6 : 32;
  const W = fishCanvas.width, H = fishCanvas.height;
  let phase = 0;

  // Launch sparkles for PB / new species
  const sparks = [];
  if (isNewSpecies || isPB) {
    for (let i = 0; i < 26; i++) {
      const a = Math.random() * Math.PI * 2, spd = 0.9 + Math.random() * 1.8;
      sparks.push({ x:W/2, y:H*0.52, vx:Math.cos(a)*spd, vy:Math.sin(a)*spd - 1.0,
        life:1, decay:0.016+Math.random()*0.014, r:1.5+Math.random()*2.5, grav:0.03,
        color:['#f0c040','#6ddb4a','#38d9c0','#ffffff'][Math.floor(Math.random()*4)] });
    }
  }

  function frame() {
    phase += 0.04;
    fctx.clearRect(0, 0, W, H);

    // Underwater gradient
    const wg = fctx.createLinearGradient(0, H*0.4, 0, H);
    wg.addColorStop(0, 'rgba(8,30,54,0)'); wg.addColorStop(1, 'rgba(6,20,42,0.7)');
    fctx.fillStyle = wg; fctx.fillRect(0, H*0.4, W, H*0.6);

    // Drifting light
    const lx = W*0.5 + Math.sin(phase*0.55)*W*0.22;
    const lg = fctx.createRadialGradient(lx, H*0.12, 0, lx, H*0.12, W*0.5);
    lg.addColorStop(0, 'rgba(56,217,192,0.07)'); lg.addColorStop(1, 'transparent');
    fctx.fillStyle = lg; fctx.fillRect(0, 0, W, H);

    // Rising bubbles
    for (let i = 0; i < 5; i++) {
      const bx = (W*0.12 + i*W*0.19 + Math.sin(phase*0.9+i*1.7)*10) % (W*0.9) + W*0.05;
      const by = H - ((phase*15 + i*H*0.19) % H);
      fctx.save(); fctx.globalAlpha = 0.12 + Math.sin(phase+i)*0.06;
      fctx.strokeStyle = 'rgba(130,210,255,0.9)'; fctx.lineWidth = 0.8;
      fctx.beginPath(); fctx.arc(bx, by, 1.6+i*0.4, 0, Math.PI*2); fctx.stroke();
      fctx.restore();
    }

    const bobY = Math.sin(phase*1.2)*5;

    // PB glow ring
    if (isNewSpecies || isPB) {
      fctx.save(); fctx.globalAlpha = 0.18 + Math.sin(phase*2)*0.09;
      fctx.strokeStyle = '#f0c040'; fctx.lineWidth = 2.5;
      fctx.beginPath(); fctx.arc(W/2, H*0.52+bobY, fishSize*1.4+Math.sin(phase*2)*4, 0, Math.PI*2); fctx.stroke();
      fctx.restore();
    }

    // Shadow
    fctx.save(); fctx.globalAlpha = 0.14;
    fctx.fillStyle = '#000';
    fctx.beginPath(); fctx.ellipse(W/2, H*0.55+fishSize*0.5, fishSize*0.95, fishSize*0.15, 0, 0, Math.PI*2); fctx.fill();
    fctx.restore();

    // Fish
    fctx.save();
    fctx.translate(W/2, H*0.52 + bobY);
    fctx.rotate(Math.sin(phase*0.8)*0.05);
    drawFishShape(fctx, { type:caughtFish.type, size:fishSize, tailPhase:phase*2.3, color:ft?ft.color:'#4488aa' });
    fctx.restore();

    // Sparkles
    sparks.forEach(sp => {
      if (sp.life <= 0) return;
      sp.x += sp.vx; sp.y += sp.vy; sp.vy += sp.grav; sp.life -= sp.decay;
      fctx.save(); fctx.globalAlpha = Math.max(0, sp.life);
      fctx.fillStyle = sp.color;
      fctx.beginPath(); fctx.arc(sp.x, sp.y, sp.r, 0, Math.PI*2); fctx.fill();
      fctx.restore();
    });

    _catchAnimId = requestAnimationFrame(frame);
  }
  frame();
}

function keepFish() {
  if (_catchAnimId) { cancelAnimationFrame(_catchAnimId); _catchAnimId = null; }
  document.getElementById('modal').classList.remove('show');
  if(aquariumFish.length<12){aquariumFish.push(caughtFish);saveData();showToast(`üè† ${caughtFish.type} added to your aquarium!`);}
  else showToast('Aquarium full! Sell this one.');
  resetFishing();
}

function releaseFish() {
  if (_catchAnimId) { cancelAnimationFrame(_catchAnimId); _catchAnimId = null; }
  document.getElementById('modal').classList.remove('show');
  playerMoney+=caughtFish.price; saveData();
  showToast(`ü™ô Sold ${caughtFish.type} for $${caughtFish.price}!`);
  resetFishing();
}

function fishEscaped() {
  playLineSnap();
  showToast('üíî LINE SNAPPED! Fish got away!',3500);
  tension=0; reelVelocity=0;
  document.getElementById('tension-hud').classList.remove('show');
  resetFishing();
}

function resetFishing() {
  hookedFish=null; floatPos=null; castLine=null; isReeling=false; isReelIn=false;
  lineHealth=100; tension=0; castSinking=false; reelVelocity=0; gameState='bait-menu';
  document.getElementById('dist-hud').className='';
  document.getElementById('tension-hud').classList.remove('show');
  document.getElementById('modal').classList.remove('show');
  updateSideBtns(); updateStateIndicator();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gameLoop(timestamp) {
  dt = lastFrameTime ? Math.min((timestamp - lastFrameTime) / 1000, 0.1) : 0.016;
  lastFrameTime = timestamp;
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

function update() {
  const s = dt * 60; // scale factor ‚Äî 1.0 at 60fps
  bobPhase += 0.05 * s;
  ripples.forEach(r=>{ r.r += 0.8*s; r.alpha -= 0.015*s; });
  ripples = ripples.filter(r=>r.alpha>0);
  carpBubbles.forEach(b=>{ b.wobble+=b.wobbleSpd*s; b.x+=Math.sin(b.wobble)*0.4; b.y-=b.vy*s; b.alpha-=0.004*s; });
  carpBubbles = carpBubbles.filter(b=>b.alpha>0);
  groundBait.forEach(gb=>{ if(!gb.settled){ gb.sinkT=Math.min(1,gb.sinkT+0.008*s); if(gb.sinkT>=1) gb.settled=true; } });
  reeds.forEach(r=>{ r.sway += r.swaySpeed*s; });

  if(gameState==='aquarium') return;
  if(gameState==='catch-modal') return; // freeze world while showing catch card

  if(floatPos&&(gameState==='fishing'||gameState==='fish-hooked')){
    const vp=document.getElementById('viewport'),vpW=vp.clientWidth,vpH=vp.clientHeight;
    viewX += (vpW/2 - floatPos.x*viewScale - viewX) * 0.04 * s;
    viewY += (vpH/2 - floatPos.y*viewScale - viewY) * 0.04 * s;
    applyTransform();
  }

  // Distance HUD during fight
  const hud=document.getElementById('dist-hud');
  if(gameState==='fish-hooked'&&hookedFish&&selectedPeg){
    const peg=pegs.find(p=>p.id===selectedPeg);
    const dist=Math.hypot(hookedFish.x-peg.x,hookedFish.y-peg.y);
    const distM=Math.min(99,Math.round(dist/25)); // world units ‚Üí realistic metres
    const maxDist=900;
    const pct=Math.max(0,Math.min(100,100-(dist/maxDist)*100));
    const barColor=pct>75?'#6ddb4a':pct>40?'#f0c040':'#f07830';
    // Stamina display
    const stamPct = Math.round(fishStamina);
    const stamColor = stamPct>60?'#6ddb4a':stamPct>30?'#f0c040':'#f04545';
    const stamLabel = stamPct>60?'üí™ Fresh':stamPct>30?'üò§ Tiring':'üòµ Exhausted';
    hud.className='show';
    hud.innerHTML=`
      <div class="dh-label">üé£ DISTANCE</div>
      <div class="dh-dist">${distM}m</div>
      <div class="dh-bar-track"><div class="dh-bar-fill" style="width:${pct}%;background:${barColor}"></div></div>
      <div class="dh-sublabel" style="color:${stamColor};font-size:0.6rem;margin-top:3px">${stamLabel}</div>
      <div class="dh-sublabel">${distM<=5?'‚úÖ ALMOST!':fishRunning?'üèÉ RUNNING':'üí§ RESTING ‚Äî REEL!'}</div>
    `;
  } else {
    hud.className='';
  }

  if(gameState==='aiming'){ angleSweep+=sweepDir*1.2*s; if(angleSweep>70||angleSweep<-70) sweepDir=-sweepDir; }
  if(gameState==='power'){ powerLevel+=powerDir*1.5*s; if(powerLevel>100||powerLevel<0) powerDir=-powerDir; powerLevel=Math.max(0,Math.min(100,powerLevel)); }
  if(castSinking){ sinkProgress=Math.min(1,sinkProgress+0.04*s); if(sinkProgress>=1) castSinking=false; }

  if((gameState==='fishing'||gameState==='fish-hooked')&&floatPos){
    if(isReelIn&&gameState==='fishing'){
      const peg=pegs.find(p=>p.id===selectedPeg);
      if(peg){ const dx=peg.x-floatPos.x,dy=peg.y-floatPos.y,d=Math.hypot(dx,dy);
        if(d>40){ floatPos.x+=dx/d*3.5*s; floatPos.y+=dy/d*3.5*s; castLine={x1:peg.x,y1:peg.y,x2:floatPos.x,y2:floatPos.y}; fishList.forEach(f=>{f.nearBait=false;f.biteTimer=0;}); }
        else { isReelIn=false; floatPos=null; castLine=null; gameState='bait-menu'; showToast('Line reeled in.'); updateSideBtns(); updateStateIndicator(); }
      }
    } else {
      bobDriftAngle += (Math.random()-0.5)*0.05*s;
      bobDriftX += Math.cos(bobDriftAngle)*0.08*s;
      bobDriftY += Math.sin(bobDriftAngle)*0.08*s;
      bobDriftX *= Math.pow(0.99, s);
      bobDriftY *= Math.pow(0.99, s);
    }
  }

  updateFish(s);
  updateHookedFish(s);
}

// ‚îÄ‚îÄ Shared fish steering ‚îÄ‚îÄ
function steerFishToTarget(f, s, speedMod) {
  const dx=f.targetX-f.x, dy=f.targetY-f.y, d=Math.hypot(dx,dy);
  if(d > 8){
    f.angle = Math.atan2(dy,dx);
    f.x += Math.cos(f.angle)*f.speed*speedMod*s;
    f.y += Math.sin(f.angle)*f.speed*speedMod*s;
    f.loiterTimer = 0;
  } else {
    f.loiterTimer += s;
    if(Math.random()<0.02*s) f.angle += (Math.random()-0.5)*0.4;
    f.x += Math.cos(f.angle)*f.speed*0.1*s;
    f.y += Math.sin(f.angle)*f.speed*0.1*s;
  }
}
function setFishTarget(f, x, y) { f.targetX=x; f.targetY=y; f.feeding=true; f.loiterTimer=0; }
function pickRandomLakeTarget(f, minR, maxR) {
  const a=Math.random()*Math.PI*2, r=minR+Math.random()*(maxR-minR);
  setFishTarget(f, LAKE_CENTER.x+Math.cos(a)*LAKE_RX*r, LAKE_CENTER.y+Math.sin(a)*LAKE_RY*r);
}
function clampFishToLake(f, s) {
  const dx=f.x-LAKE_CENTER.x, dy=f.y-LAKE_CENTER.y, nd=Math.hypot(dx/LAKE_RX,dy/LAKE_RY);
  if(nd>0.92){ f.angle=Math.atan2(-dy,-dx)+(Math.random()-0.5)*0.6; f.x=LAKE_CENTER.x+(dx/nd)*LAKE_RX*0.88; f.y=LAKE_CENTER.y+(dy/nd)*LAKE_RY*0.88; f.feeding=false; f.targetX=null; f.targetY=null; f.loiterTimer=0; }
  else if(nd>0.82){ const pressure=(nd-0.82)/0.10; f.angle+=Math.atan2(LAKE_CENTER.y-f.y,LAKE_CENTER.x-f.x)*pressure*0.06*s; }
}

function updateFish(s) {
  const nf=getNightFactor(), isNight=nf>0.5;
  fishList.forEach(f=>{
    f.tailPhase += 0.08*s;
    let speedMod=1.0, biteMulti=1.0;
    if(f.behavior==='nocturnal'){ speedMod=isNight?1.5:0.25; biteMulti=isNight?2.0:0.2; }
    else if(f.behavior==='ambush'){ speedMod=isNight?1.0:0.25; biteMulti=isNight?1.6:0.5; }

    // Ground bait attraction (shared)
    let nearBait=null, nearDist=Infinity;
    groundBait.forEach(gb=>{
      if(!gb.settled&&gb.sinkT<0.8) return;
      const d=Math.hypot(f.x-gb.x,f.y-gb.y), range=gb.baitId===f.favBait?500:320;
      if(d<range&&Math.abs(f.depth-gb.depth)<1.5&&d<nearDist){ nearDist=d; nearBait=gb; }
    });
    if(nearBait&&!f.feeding){ setFishTarget(f, nearBait.x, nearBait.y); f.depth=nearBait.depth; }

    // Float bite detection (shared)
    if(floatPos&&gameState==='fishing'&&!hookedFish){
      const dist=Math.hypot(f.x-floatPos.x,f.y-floatPos.y), depthMatch=Math.abs(f.depth-floatDepth)<1.5;
      const isFav=selectedBait&&selectedBait.id===f.favBait, isOk=selectedBait&&f.okBaits.includes(selectedBait.id);
      const biteRadius=isFav?120:isOk?80:50;
      if(dist<biteRadius&&depthMatch&&!castSinking){
        if(!f.nearBait){ f.nearBait=true; const bt=isFav?800:isOk?2000:4000; f.biteTimer=(bt+Math.random()*2000)/biteMulti; }
      } else { f.nearBait=false; f.biteTimer=0; }
      if(f.nearBait&&f.biteTimer>0){ f.biteTimer-=dt*1000; if(f.biteTimer<=0) hookFish(f); }
    }

    // Behavior-specific movement (all use shared steerFishToTarget)
    if(f.behavior==='roamer'){
      f.roamTimer -= s;
      if(f.roamTimer<=0||!f.feeding){ pickRandomLakeTarget(f,0.3,0.85); f.roamTimer=220+Math.random()*280; }
      steerFishToTarget(f, s, speedMod);
      // Occasional surface bubbles from carp
      if(f.type==='Carp' && Math.random()<0.004*s && carpBubbles.length<80){
        const nx = f.x + (Math.random()-0.5)*30;
        const ny = f.y + (Math.random()-0.5)*20;
        for(let i=0;i<2+Math.floor(Math.random()*3);i++){
          carpBubbles.push({x:nx+(Math.random()-0.5)*18,y:ny,r:1.5+Math.random()*3.5,alpha:0.7+Math.random()*0.3,vy:0.3+Math.random()*0.5,wobble:Math.random()*Math.PI*2,wobbleSpd:0.04+Math.random()*0.04});
        }
      }

    } else if(f.behavior==='ambush'){
      f.ambushTimer -= s;
      if(f.ambushTimer<=0){
        const useR=Math.random()<0.5, zones=useR?reedPatches:lilyClusters;
        if(zones.length){ const zone=zones[Math.floor(Math.random()*zones.length)]; let tx=zone.cx+(Math.random()-0.5)*zone.spread*0.8, ty=zone.cy+(Math.random()-0.5)*zone.spread*0.8; const td=Math.hypot((tx-LAKE_CENTER.x)/LAKE_RX,(ty-LAKE_CENTER.y)/LAKE_RY); if(td>0.85){tx=LAKE_CENTER.x+(tx-LAKE_CENTER.x)/td*LAKE_RX*0.80;ty=LAKE_CENTER.y+(ty-LAKE_CENTER.y)/td*LAKE_RY*0.80;} setFishTarget(f,tx,ty); }
        f.ambushTimer = isNight?(150+Math.random()*200):(400+Math.random()*600);
      }
      if(f.feeding&&f.targetX!==null) steerFishToTarget(f, s, speedMod);

    } else if(f.behavior==='nocturnal'){
      if(isNight){
        if(!f.feeding||f.loiterTimer>180){ pickRandomLakeTarget(f,0.2,0.65); }
        steerFishToTarget(f, s, speedMod);
      } else {
        if(Math.random()<0.005*s) f.angle += (Math.random()-0.5)*0.3;
        f.x += Math.cos(f.angle)*f.speed*0.12*s;
        f.y += Math.sin(f.angle)*f.speed*0.12*s;
      }

    } else { // normal
      if(!f.feeding||f.loiterTimer>300){ f.feeding=false; f.targetX=null; f.targetY=null; f.loiterTimer=0; }
      if(!f.feeding&&Math.random()<0.012*s){ pickRandomLakeTarget(f,0.15,0.85); }
      if(f.feeding&&f.targetX!==null) steerFishToTarget(f, s, speedMod);
      else { if(Math.random()<0.015*s) f.angle+=(Math.random()-0.5)*0.6; if(Math.random()<0.05*s) f.depth=Math.max(1,Math.min(3,f.depth+(Math.random()-0.5))); f.x+=Math.cos(f.angle)*f.speed*speedMod*s; f.y+=Math.sin(f.angle)*f.speed*speedMod*s; }
    }

    clampFishToLake(f, s);
  });
}

function updateHookedFish(s) {
  if(gameState!=='fish-hooked'||!hookedFish) return;
  const peg = pegs.find(p=>p.id===selectedPeg);
  const reel = getActiveReel();
  const tensionMax = reel.tensionMax;
  const reelMult = reel.reelMult;
  const msPerFrame = dt * 1000;

  // Fish phase modifiers (fresh = strong/unpredictable, exhausted = slow/weaker)
  const freshPhase  = fishStamina > 60;
  const tiringPhase = fishStamina > 25 && fishStamina <= 60;
  const exhaustedPhase = fishStamina <= 25;

  if(fishRunning){
    runTimer -= msPerFrame;
    // Stamina drains faster if we reel against the fish
    fishStamina -= (isReeling ? 0.22 : 0.07) * s;

    const fatigueSpeed = 0.45 + (fishStamina/100)*0.55;

    // Fresh fish: erratic angle changes and powerful runs
    // Tiring: less erratic, slower
    // Exhausted: slow, mostly straight toward edge
    const zigzagRate = freshPhase ? 0.07 : tiringPhase ? 0.03 : 0.01;
    if(Math.random() < zigzagRate * s) {
      const zigStrength = freshPhase ? 2.2 : 1.0;
      hookedFish.angle += (Math.random()-0.5) * zigStrength;
    }

    // Fresh fish occasionally make sharp direction reversal darts
    if(freshPhase && Math.random() < 0.015 * s) {
      hookedFish.angle = Math.atan2(hookedFish.y-peg.y, hookedFish.x-peg.x) + (Math.random()-0.5)*2.5;
    }

    const speedMultiplier = freshPhase ? 1.0 : tiringPhase ? 0.72 : 0.4;
    const rs = hookedFish.speed * (2.5 + hookedFish.size*0.04) * fatigueSpeed * speedMultiplier;
    hookedFish.x += Math.cos(hookedFish.angle)*rs*s;
    hookedFish.y += Math.sin(hookedFish.angle)*rs*s;
    hookedFish.tailPhase += (freshPhase ? 0.35 : 0.2) * s;

    const dx=hookedFish.x-LAKE_CENTER.x, dy=hookedFish.y-LAKE_CENTER.y, ed=Math.hypot(dx/LAKE_RX,dy/LAKE_RY);
    if(ed>0.90){ hookedFish.angle=Math.atan2(-dy,-dx)+(Math.random()-0.5)*0.6; hookedFish.x=LAKE_CENTER.x+(dx/ed)*LAKE_RX*0.87; hookedFish.y=LAKE_CENTER.y+(dy/ed)*LAKE_RY*0.87; }

    floatPos = {x:hookedFish.x, y:hookedFish.y};

    // Tension rises faster for fresh/strong fish
    const tensionRise = freshPhase ? 3.2 : tiringPhase ? 2.4 : 1.4;
    if(isReeling) tension += tensionRise * s;
    else tension -= 1.2 * s;

    const staminaMod = 0.4 + (fishStamina/100)*0.6;
    if(runTimer<=0){
      fishRunning = false;
      restTimer = Math.max(800, (4500-hookedFish.size*60+Math.random()*3000) * staminaMod);
    }

  } else {
    restTimer -= msPerFrame;
    // Resting recovery ‚Äî exhausted fish recover less
    const recoverRate = exhaustedPhase ? 0.015 : freshPhase ? 0.06 : 0.035;
    fishStamina = Math.max(0, Math.min(100, fishStamina + recoverRate * s));

    if(isReeling){
      const dx=peg.x-hookedFish.x, dy=peg.y-hookedFish.y, d=Math.hypot(dx,dy);
      if(d<200){ catchFish(); return; }

      // Sweet-spot bonus: reel faster when tension is in green zone
      const sweetBonus = sweetSpotInZone ? 1.5 : 1.0;
      const targetSpeed = 2.5 * reelMult * sweetBonus;
      reelVelocity += (targetSpeed - reelVelocity) * 0.06 * s;
      hookedFish.x += dx/d*reelVelocity*s;
      hookedFish.y += dy/d*reelVelocity*s;
      floatPos = {x:hookedFish.x, y:hookedFish.y};
      tension -= 0.5 * s;
    } else {
      reelVelocity += (0 - reelVelocity) * 0.12 * s;
      tension -= 1.2 * s;
    }

    if(restTimer<=0){
      fishRunning = true;
      const staminaMod = exhaustedPhase ? 0.2 : tiringPhase ? 0.5 : 0.9;
      runTimer = (1500 + Math.random()*2500 + hookedFish.size*40) * (staminaMod + 0.1);
      // Exhausted fish: mostly run toward edge weakly; fresh fish: run away from peg aggressively
      const angleVariance = exhaustedPhase ? 1.8 : tiringPhase ? 1.2 : 0.8;
      hookedFish.angle = Math.atan2(hookedFish.y-peg.y, hookedFish.x-peg.x) + (Math.random()-0.5)*angleVariance;
    }
  }

  tension = Math.max(0, Math.min(tensionMax, tension));
  const normTension = (tension / tensionMax) * 100;
  if(normTension >= 100){ fishEscaped(); return; }
  updateSideBtns();
  updateTensionHUD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function draw() {
  ctx.clearRect(0,0,WORLD_W,WORLD_H);
  const nf=getNightFactor();
  const dg=[61,107,42],ng=[22,40,12];
  const gr=Math.round(dg[0]*(1-nf)+ng[0]*nf),gg=Math.round(dg[1]*(1-nf)+ng[1]*nf),gb=Math.round(dg[2]*(1-nf)+ng[2]*nf);
  ctx.fillStyle=`rgb(${gr},${gg},${gb})`; ctx.fillRect(0,0,WORLD_W,WORLD_H);

  const grassSeed=42;
  function pseudo(x,y,s){ return Math.abs((Math.sin(x*0.017*s+y*0.013*s+grassSeed)*43758.5453)%1); }

  for(let i=0;i<WORLD_W;i+=80){
    for(let j=0;j<WORLD_H;j+=80){
      const v=pseudo(i,j,1);
      if(v>0.5){
        const bright=(v-0.5)*0.18*(1-nf*0.6);
        ctx.fillStyle=`rgba(${Math.round(gr+bright*30)},${Math.round(gg+bright*40)},${Math.round(gb+bright*10)},0.55)`;
        const sz=Math.max(1, 50+pseudo(i,j,2)*40);
        ctx.beginPath(); ctx.ellipse(i+20,j+20,sz,sz*0.6,pseudo(i,j,3)*Math.PI,0,Math.PI*2); ctx.fill();
      }
    }
  }
  for(let i=0;i<WORLD_W;i+=38){
    for(let j=0;j<WORLD_H;j+=38){
      const v=pseudo(i,j,4);
      if(v>0.6){
        const alpha=(0.06+v*0.08)*(1-nf*0.5);
        ctx.fillStyle=`rgba(80,160,45,${alpha})`;
        const sz=Math.max(1, 8+pseudo(i,j,5)*14);
        ctx.beginPath(); ctx.ellipse(i+pseudo(i,j,6)*12,j+pseudo(i,j,7)*12,sz,sz*0.55,pseudo(i,j,8)*Math.PI,0,Math.PI*2); ctx.fill();
      }
    }
  }
  ctx.strokeStyle=`rgba(60,130,30,${0.07*(1-nf*0.6)})`;
  ctx.lineWidth=1;
  for(let i=0;i<WORLD_W;i+=22){
    for(let j=0;j<WORLD_H;j+=22){
      if(pseudo(i,j,9)>0.55){
        const ox=pseudo(i,j,10)*10, oy=pseudo(i,j,11)*10;
        const len=Math.max(0.5, 4+pseudo(i,j,12)*6), ang=(-0.6+pseudo(i,j,13)*1.2);
        ctx.beginPath(); ctx.moveTo(i+ox,j+oy); ctx.lineTo(i+ox+Math.cos(ang)*len,j+oy-len*0.8); ctx.stroke();
      }
    }
  }
  for(let i=0;i<WORLD_W;i+=55){
    for(let j=0;j<WORLD_H;j+=55){
      if(pseudo(i,j,14)>0.75){
        ctx.fillStyle=`rgba(30,20,10,${0.08*(1-nf*0.7)})`;
        const sz=Math.max(1, 5+pseudo(i,j,15)*10);
        ctx.beginPath(); ctx.ellipse(i+pseudo(i,j,16)*20,j+pseudo(i,j,17)*20,sz,sz*0.6,0,0,Math.PI*2); ctx.fill();
      }
    }
  }

  drawLake(); drawLilyPads(); drawReeds(); drawGroundBait(); drawFish(); drawCarpBubbles(); drawPegs(); drawFloat(); drawAimingArc(); drawRipples();
  const sky=getSkyOverlay();
  if(sky.a>0.01){ctx.save();ctx.globalAlpha=sky.a;ctx.fillStyle=`rgb(${Math.round(sky.r)},${Math.round(sky.g)},${Math.round(sky.b)})`;ctx.fillRect(0,0,WORLD_W,WORLD_H);ctx.restore();}
  if(nf>0.3)drawStars(nf);
  drawFightOverlay();
  drawTimeHUD();
}

function drawLake() {
  const nf=getNightFactor(),phase=getDayPhase();
  function lc(a,b,t){return a.map((v,i)=>Math.round(v*(1-t)+b[i]*t));}
  const deep=lc([26,74,110],[8,18,48],nf),mid=lc([33,94,138],[12,28,62],nf),shore=lc([58,130,190],[18,42,88],nf);
  const sw=shore;
  const grad=ctx.createRadialGradient(LAKE_CENTER.x,LAKE_CENTER.y,100,LAKE_CENTER.x,LAKE_CENTER.y,Math.max(LAKE_RX,LAKE_RY));
  grad.addColorStop(0,`rgb(${deep.join(',')})`); grad.addColorStop(0.5,`rgb(${mid.join(',')})`); grad.addColorStop(0.85,`rgb(${shore.join(',')})`); grad.addColorStop(1,`rgb(${sw.join(',')})`);
  buildLakePath(); ctx.fillStyle=grad; ctx.fill();
  ctx.save(); buildLakePath(); ctx.clip();
  ctx.strokeStyle='rgba(255,255,255,0.04)'; ctx.lineWidth=2;
  for(let y=LAKE_CENTER.y-LAKE_RY;y<LAKE_CENTER.y+LAKE_RY;y+=40){const off=Math.sin(bobPhase*0.5+y*0.01)*15;ctx.beginPath();ctx.moveTo(LAKE_CENTER.x-LAKE_RX,y+off);ctx.lineTo(LAKE_CENTER.x+LAKE_RX,y-off);ctx.stroke();}
  ctx.restore();
  buildLakePath(); ctx.strokeStyle='#c8a86b'; ctx.lineWidth=12; ctx.stroke();
  buildLakePath(); ctx.strokeStyle='#a0845a'; ctx.lineWidth=5; ctx.stroke();
}

function drawLilyPads() {
  lilyPads.forEach(lp=>{
    ctx.save(); ctx.translate(lp.x,lp.y); ctx.rotate(lp.rot+Math.sin(bobPhase*0.3+lp.x)*0.04);
    ctx.beginPath(); ctx.arc(0,0,lp.r,0,Math.PI*2); ctx.fillStyle='#2d5a1b'; ctx.fill();
    ctx.fillStyle='#1a4a6e'; ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,lp.r,-0.2,0.2); ctx.closePath(); ctx.fill();
    ctx.strokeStyle='rgba(80,160,60,0.4)'; ctx.lineWidth=0.8;
    for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(Math.cos(a)*lp.r*0.9,Math.sin(a)*lp.r*0.9);ctx.stroke();}
    if(lp.flower){ctx.fillStyle='#ffeb6a';ctx.beginPath();ctx.arc(0,0,4,0,Math.PI*2);ctx.fill();for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2;ctx.beginPath();ctx.ellipse(Math.cos(a)*7,Math.sin(a)*7,3,5,a,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,0.85)';ctx.fill();}}
    ctx.restore();
  });
}

function drawReeds() {
  reeds.forEach(r=>{
    const sway=Math.sin(r.sway)*6;
    ctx.save(); ctx.translate(r.x,r.y);
    ctx.strokeStyle='#7a5c2a'; ctx.lineWidth=2.5; ctx.beginPath(); ctx.moveTo(0,0); ctx.bezierCurveTo(sway*0.3,-r.h*0.4,sway*0.6,-r.h*0.7,sway,-r.h); ctx.stroke();
    ctx.fillStyle='#4a2d0a'; ctx.beginPath(); ctx.ellipse(sway,-r.h,4,14,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(200,180,120,0.5)'; ctx.lineWidth=1;
    for(let i=0;i<3;i++){ctx.beginPath();ctx.moveTo(sway+(i-1)*3,-r.h-14);ctx.lineTo(sway+(i-1)*6+sway*0.3,-r.h-30);ctx.stroke();}
    ctx.restore();
  });
}

function drawGroundBait() {
  groundBait.forEach(gb=>{
    const sinkOff=gb.settled?0:(1-gb.sinkT)*-20,sinkAlpha=gb.settled?1:gb.sinkT;
    const baseAlpha=debugMode?0.9:(gb.depth===1?0.55:0.2);
    ctx.save(); ctx.globalAlpha=baseAlpha*sinkAlpha; ctx.translate(gb.x,gb.y+sinkOff);
    if(!gb.settled&&gb.sinkT<0.3){ctx.beginPath();ctx.arc(0,0,gb.sinkT*50,0,Math.PI*2);ctx.strokeStyle='rgba(150,220,255,0.5)';ctx.lineWidth=1.5;ctx.stroke();}
    ctx.beginPath();ctx.arc(0,0,16,0,Math.PI*2);ctx.fillStyle='rgba(160,100,30,0.6)';ctx.fill();
    ctx.beginPath();ctx.arc(0,0,8,0,Math.PI*2);ctx.fillStyle='rgba(200,140,60,0.8)';ctx.fill();
    ctx.restore();
  });
}

function drawFish() {
  fishList.forEach(f=>{
    const isHooked=f===hookedFish&&gameState==='fish-hooked';
    const visible=debugMode||f.depth<1.6||isHooked;
    if(!visible)return;
    const opacity=isHooked?Math.min(1,0.5+tension*0.005):(debugMode?0.95:Math.max(0,1.4-f.depth*0.5));
    ctx.save();ctx.translate(f.x,f.y);ctx.rotate(f.angle);ctx.globalAlpha=opacity;
    if(isHooked&&fishRunning){ctx.beginPath();ctx.arc(0,0,f.size*1.8+Math.sin(bobPhase*6)*4,0,Math.PI*2);ctx.strokeStyle=`rgba(240,69,69,${0.25+0.2*Math.sin(bobPhase*6)})`;ctx.lineWidth=3;ctx.stroke();}
    drawFishShape(ctx,f); ctx.restore();
    if(debugMode){ctx.save();ctx.globalAlpha=1;ctx.fillStyle='rgba(255,255,255,0.9)';ctx.font='bold 11px Nunito,sans-serif';ctx.textAlign='center';ctx.fillText(`${f.type} D:${f.depth.toFixed(1)}`,f.x,f.y-f.size-10);if(f.nearBait){ctx.fillStyle='#ff5252';ctx.fillText(`‚è±${(f.biteTimer/1000).toFixed(1)}s`,f.x,f.y-f.size-22);}ctx.textAlign='left';ctx.restore();}
  });
}

function drawFishShape(ctx,f) {
  const s=f.size,tw=Math.sin(f.tailPhase)*0.4;
  switch(f.type){
    case'Carp':drawCarp(ctx,s,tw,f.color);break;case'Roach':drawRoach(ctx,s,tw,f.color);break;
    case'Eel':drawEel(ctx,s,tw,f.color);break;case'Pike':drawPike(ctx,s,tw,f.color);break;
    case'Bream':drawBream(ctx,s,tw,f.color);break;case'Tench':drawTench(ctx,s,tw,f.color);break;
    case'Perch':drawPerch(ctx,s,tw,f.color);break;default:drawGenericFish(ctx,s,tw,f.color);
  }
}

function hexToRgb(h){const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return{r,g,b};}
function lighten(h,a=40){const{r,g,b}=hexToRgb(h);return`rgb(${Math.min(255,r+a)},${Math.min(255,g+a)},${Math.min(255,b+a)})`;}
function darken(h,a=40){const{r,g,b}=hexToRgb(h);return`rgb(${Math.max(0,r-a)},${Math.max(0,g-a)},${Math.max(0,b-a)})`;}

function drawCarp(ctx,s,tw,c){
  const bg=ctx.createRadialGradient(s*0.1,-s*0.1,1,0,0,s);bg.addColorStop(0,lighten(c,50));bg.addColorStop(0.6,c);bg.addColorStop(1,darken(c,30));
  ctx.save();ctx.translate(-s*0.85,0);ctx.rotate(tw);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-s*0.7,-s*0.55);ctx.lineTo(-s*0.55,0);ctx.lineTo(-s*0.7,s*0.55);ctx.closePath();ctx.fillStyle=darken(c,20);ctx.fill();ctx.restore();
  ctx.beginPath();ctx.ellipse(0,0,s,s*0.55,0,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();ctx.strokeStyle=darken(c,40);ctx.lineWidth=1.5;ctx.stroke();
  ctx.strokeStyle='rgba(0,0,0,0.1)';ctx.lineWidth=0.8;for(let i=-1;i<=1;i++){ctx.beginPath();ctx.arc(s*0.1+i*s*0.35,i*s*0.18,s*0.22,0,Math.PI*2);ctx.stroke();}
  ctx.beginPath();ctx.moveTo(-s*0.1,-s*0.55);ctx.lineTo(s*0.3,-s*0.95);ctx.lineTo(s*0.6,-s*0.55);ctx.fillStyle=darken(c,15);ctx.fill();
  ctx.beginPath();ctx.ellipse(s*0.25,s*0.42,s*0.28,s*0.12,0.5,0,Math.PI*2);ctx.fillStyle=lighten(c,20);ctx.fill();
  ctx.strokeStyle=darken(c,30);ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(s*0.85,-s*0.05);ctx.lineTo(s*1.1,-s*0.2);ctx.stroke();ctx.beginPath();ctx.moveTo(s*0.85,s*0.05);ctx.lineTo(s*1.1,s*0.15);ctx.stroke();
  ctx.beginPath();ctx.arc(s*0.62,-s*0.15,s*0.13,0,Math.PI*2);ctx.fillStyle='#1a1a1a';ctx.fill();ctx.beginPath();ctx.arc(s*0.64,-s*0.17,s*0.05,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
}
function drawRoach(ctx,s,tw,c){
  const bg=ctx.createLinearGradient(0,-s*0.4,0,s*0.4);bg.addColorStop(0,lighten(c,60));bg.addColorStop(0.5,c);bg.addColorStop(1,darken(c,20));
  ctx.save();ctx.translate(-s*0.85,0);ctx.rotate(tw);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-s*0.65,-s*0.45);ctx.lineTo(-s*0.65,s*0.45);ctx.closePath();ctx.fillStyle='rgba(200,100,100,0.7)';ctx.fill();ctx.restore();
  ctx.beginPath();ctx.ellipse(0,0,s,s*0.42,0,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();ctx.strokeStyle=darken(c,30);ctx.lineWidth=1;ctx.stroke();
  ctx.beginPath();ctx.moveTo(-s*0.7,0);ctx.lineTo(s*0.8,0);ctx.strokeStyle='rgba(180,180,220,0.4)';ctx.lineWidth=2;ctx.stroke();
  ctx.beginPath();ctx.moveTo(s*0.1,-s*0.42);ctx.lineTo(s*0.35,-s*0.75);ctx.lineTo(s*0.6,-s*0.42);ctx.fillStyle='rgba(220,80,80,0.7)';ctx.fill();
  ctx.beginPath();ctx.arc(s*0.6,-s*0.1,s*0.11,0,Math.PI*2);ctx.fillStyle='#1a1a1a';ctx.fill();ctx.beginPath();ctx.arc(s*0.62,-s*0.12,s*0.04,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
}
function drawEel(ctx,s,tw,c){
  const w=Math.sin(tw*3)*s*0.3;
  ctx.beginPath();ctx.moveTo(s*1.2,0);ctx.bezierCurveTo(s*0.4,-w,-s*0.4,w,-s*1.2,-w*0.5);ctx.lineWidth=s*0.28;ctx.strokeStyle=c;ctx.lineCap='round';ctx.stroke();
  ctx.beginPath();ctx.moveTo(s*1.0,0);ctx.bezierCurveTo(s*0.3,-w*0.7,-s*0.3,w*0.7,-s*1.0,-w*0.4);ctx.lineWidth=s*0.1;ctx.strokeStyle=lighten(c,50);ctx.stroke();
  ctx.beginPath();ctx.ellipse(s*1.1,0,s*0.25,s*0.18,0,0,Math.PI*2);ctx.fillStyle=lighten(c,20);ctx.fill();
  ctx.beginPath();ctx.arc(s*1.2,-s*0.06,s*0.07,0,Math.PI*2);ctx.fillStyle='#0a0a0a';ctx.fill();ctx.beginPath();ctx.arc(s*1.21,-s*0.07,s*0.025,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
}
function drawPike(ctx,s,tw,c){
  const bg=ctx.createLinearGradient(-s,0,s,0);bg.addColorStop(0,darken(c,30));bg.addColorStop(0.4,lighten(c,30));bg.addColorStop(1,darken(c,20));
  ctx.save();ctx.translate(-s*0.9,0);ctx.rotate(tw);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-s*0.7,-s*0.5);ctx.lineTo(-s*0.4,0);ctx.lineTo(-s*0.7,s*0.5);ctx.closePath();ctx.fillStyle=darken(c,25);ctx.fill();ctx.restore();
  ctx.beginPath();ctx.ellipse(0,0,s*1.1,s*0.32,0,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();ctx.strokeStyle=darken(c,40);ctx.lineWidth=1.5;ctx.stroke();
  ctx.fillStyle='rgba(0,0,0,0.15)';for(let i=-2;i<=2;i++){ctx.beginPath();ctx.ellipse(i*s*0.28,s*0.1,s*0.1,s*0.28,0.3,0,Math.PI*2);ctx.fill();}
  ctx.beginPath();ctx.moveTo(-s*0.3,-s*0.32);ctx.lineTo(-s*0.1,-s*0.7);ctx.lineTo(s*0.1,-s*0.32);ctx.fillStyle=darken(c,10);ctx.fill();
  ctx.beginPath();ctx.arc(s*0.78,-s*0.12,s*0.12,0,Math.PI*2);ctx.fillStyle='#e8c020';ctx.fill();ctx.beginPath();ctx.arc(s*0.78,-s*0.12,s*0.07,0,Math.PI*2);ctx.fillStyle='#0a0a0a';ctx.fill();ctx.beginPath();ctx.arc(s*0.8,-s*0.14,s*0.03,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
}
function drawBream(ctx,s,tw,c){
  const bg=ctx.createRadialGradient(s*0.1,-s*0.2,1,0,0,s);bg.addColorStop(0,lighten(c,50));bg.addColorStop(0.7,c);bg.addColorStop(1,darken(c,40));
  ctx.save();ctx.translate(-s*0.8,0);ctx.rotate(tw);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-s*0.55,-s*0.55);ctx.lineTo(-s*0.55,s*0.55);ctx.closePath();ctx.fillStyle=darken(c,15);ctx.fill();ctx.restore();
  ctx.beginPath();ctx.ellipse(0,0,s*0.85,s*0.72,0,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();ctx.strokeStyle=darken(c,30);ctx.lineWidth=1.5;ctx.stroke();
  ctx.beginPath();ctx.moveTo(-s*0.1,-s*0.72);ctx.lineTo(s*0.15,-s*1.15);ctx.lineTo(s*0.5,-s*0.72);ctx.fillStyle=darken(c,10);ctx.fill();
  ctx.beginPath();ctx.arc(s*0.55,-s*0.15,s*0.12,0,Math.PI*2);ctx.fillStyle='#1a1a1a';ctx.fill();ctx.beginPath();ctx.arc(s*0.57,-s*0.17,s*0.04,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
}
function drawTench(ctx,s,tw,c){
  const bg=ctx.createRadialGradient(0,-s*0.1,1,0,0,s);bg.addColorStop(0,lighten(c,55));bg.addColorStop(0.5,c);bg.addColorStop(1,darken(c,35));
  ctx.save();ctx.translate(-s*0.8,0);ctx.rotate(tw);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-s*0.6,-s*0.42);ctx.quadraticCurveTo(-s*0.75,0,-s*0.6,s*0.42);ctx.closePath();ctx.fillStyle=darken(c,15);ctx.fill();ctx.restore();
  ctx.beginPath();ctx.ellipse(0,0,s*0.95,s*0.58,0,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();ctx.strokeStyle=darken(c,40);ctx.lineWidth=1.5;ctx.stroke();
  ctx.beginPath();ctx.moveTo(-s*0.05,-s*0.58);ctx.quadraticCurveTo(s*0.25,-s*0.95,s*0.55,-s*0.58);ctx.fillStyle=darken(c,10);ctx.fill();
  ctx.beginPath();ctx.arc(s*0.62,-s*0.13,s*0.13,0,Math.PI*2);ctx.fillStyle='#e87020';ctx.fill();ctx.beginPath();ctx.arc(s*0.62,-s*0.13,s*0.08,0,Math.PI*2);ctx.fillStyle='#0a0a0a';ctx.fill();
}
function drawGenericFish(ctx,s,tw,c){
  ctx.save();ctx.translate(-s*0.85,0);ctx.rotate(tw);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-s*0.6,-s*0.5);ctx.lineTo(-s*0.6,s*0.5);ctx.closePath();ctx.fillStyle=c;ctx.fill();ctx.restore();
  ctx.beginPath();ctx.ellipse(0,0,s,s*0.45,0,0,Math.PI*2);ctx.fillStyle=c;ctx.fill();ctx.beginPath();ctx.arc(s*0.55,-s*0.1,s*0.12,0,Math.PI*2);ctx.fillStyle='#111';ctx.fill();
}
function drawPerch(ctx,s,tw,c){
  const bg=ctx.createLinearGradient(-s,-s*0.4,s,s*0.4);bg.addColorStop(0,darken(c,20));bg.addColorStop(0.3,lighten(c,40));bg.addColorStop(0.7,c);bg.addColorStop(1,darken(c,30));
  ctx.save();ctx.translate(-s*0.8,0);ctx.rotate(tw);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-s*0.65,-s*0.48);ctx.lineTo(-s*0.65,s*0.48);ctx.closePath();ctx.fillStyle=darken(c,30);ctx.fill();ctx.restore();
  ctx.beginPath();ctx.ellipse(0,0,s*0.95,s*0.48,0,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();ctx.strokeStyle=darken(c,40);ctx.lineWidth=1.2;ctx.stroke();
  ctx.fillStyle='rgba(0,0,0,0.22)';for(let i=-1;i<=2;i++){ctx.beginPath();ctx.ellipse(i*s*0.3,0,s*0.065,s*0.46,0,0,Math.PI*2);ctx.fill();}
  ctx.fillStyle='rgba(40,80,30,0.7)';ctx.beginPath();ctx.moveTo(-s*0.2,-s*0.48);for(let i=0;i<6;i++){ctx.lineTo(-s*0.2+i*s*0.13,-s*0.48-(i%2===0?s*0.52:s*0.30));}ctx.lineTo(s*0.4,-s*0.48);ctx.closePath();ctx.fill();ctx.strokeStyle=darken(c,30);ctx.lineWidth=0.8;ctx.stroke();
  ctx.beginPath();ctx.ellipse(s*0.2,s*0.44,s*0.26,s*0.1,0.3,0,Math.PI*2);ctx.fillStyle='rgba(220,90,50,0.65)';ctx.fill();
  ctx.beginPath();ctx.arc(s*0.55,-s*0.12,s*0.14,0,Math.PI*2);ctx.fillStyle='#e8e020';ctx.fill();ctx.beginPath();ctx.arc(s*0.55,-s*0.12,s*0.09,0,Math.PI*2);ctx.fillStyle='#0a0a0a';ctx.fill();ctx.beginPath();ctx.arc(s*0.57,-s*0.14,s*0.035,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,0.85)';ctx.fill();
}

function drawPegs() {
  pegs.forEach(peg=>{
    const sel = selectedPeg === peg.id;
    const faceAngle = pegFacingAngle(peg);
    const faceRad   = faceAngle * Math.PI / 180;
    const backRad   = faceRad + Math.PI;
    const anglerRot = backRad - Math.PI / 2;

    ctx.save();
    ctx.translate(peg.x, peg.y);
    ctx.rotate(anglerRot);
    const pw = 52, ph = 36;
    ctx.fillStyle = '#8B6030';
    ctx.beginPath(); ctx.roundRect(-pw/2, -ph/2, pw, ph, 4); ctx.fill();
    ctx.strokeStyle = '#6B4820'; ctx.lineWidth = 1.5; ctx.stroke();
    ctx.strokeStyle = '#6B4820'; ctx.lineWidth = 1;
    for(let xi = -pw/2+10; xi < pw/2; xi += 13){
      ctx.beginPath(); ctx.moveTo(xi, -ph/2); ctx.lineTo(xi, ph/2); ctx.stroke();
    }
    ctx.strokeStyle = 'rgba(0,0,0,0.12)'; ctx.lineWidth = 0.5;
    for(let yi = -ph/2+8; yi < ph/2; yi += 8){
      ctx.beginPath(); ctx.moveTo(-pw/2, yi); ctx.lineTo(pw/2, yi); ctx.stroke();
    }
    ctx.fillStyle = '#5a3810';
    [[-pw/2+3,-ph/2+3],[pw/2-3,-ph/2+3],[-pw/2+3,ph/2-3],[pw/2-3,ph/2-3]].forEach(([px,py])=>{
      ctx.beginPath(); ctx.arc(px, py, 3.5, 0, Math.PI*2); ctx.fill();
    });
    ctx.restore();

    ctx.beginPath(); ctx.arc(peg.x, peg.y, sel ? 11 : 9, 0, Math.PI*2);
    ctx.fillStyle = sel ? '#d4a847' : '#8B6914'; ctx.fill();
    ctx.strokeStyle = sel ? '#fff7c0' : '#c8a860'; ctx.lineWidth = 2; ctx.stroke();

    const lblDist = 22;
    const lblX = peg.x + Math.cos(backRad) * lblDist;
    const lblY = peg.y + Math.sin(backRad) * lblDist;
    ctx.save();
    ctx.fillStyle = 'rgba(0,0,0,0.55)';
    ctx.beginPath(); ctx.roundRect(lblX-11, lblY-10, 22, 18, 4); ctx.fill();
    ctx.fillStyle = sel ? '#ffe040' : '#fff';
    ctx.font = `bold ${sel?13:11}px Nunito,sans-serif`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(`P${peg.id}`, lblX, lblY);
    ctx.textAlign = 'left'; ctx.textBaseline = 'alphabetic';
    ctx.restore();

    if(sel){
      ctx.save();
      ctx.translate(peg.x, peg.y);

      const bivvyDist = 100;
      ctx.save();
      ctx.translate(Math.cos(backRad)*bivvyDist, Math.sin(backRad)*bivvyDist);
      ctx.rotate(faceRad - Math.PI/2);
      const bgg = ctx.createLinearGradient(-36,-10,36,30);
      bgg.addColorStop(0,'#4a5c3a'); bgg.addColorStop(0.5,'#3a4a2e'); bgg.addColorStop(1,'#2a3820');
      ctx.beginPath();
      ctx.moveTo(-38,28);
      ctx.bezierCurveTo(-38,28,-30,-35,0,-48);
      ctx.bezierCurveTo(30,-35,38,28,38,28);
      ctx.closePath();
      ctx.fillStyle = bgg; ctx.fill();
      ctx.strokeStyle = '#2a3820'; ctx.lineWidth = 2; ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(-14,28); ctx.bezierCurveTo(-14,28,-12,-5,0,-12); ctx.bezierCurveTo(12,-5,14,28,14,28);
      ctx.closePath(); ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fill();
      ctx.strokeStyle = 'rgba(200,180,120,0.6)'; ctx.lineWidth = 1; ctx.setLineDash([3,3]);
      [[-50,20],[50,20],[-40,60],[40,60]].forEach(([rx,ry])=>{
        ctx.beginPath(); ctx.moveTo(rx<0?-38:38,10); ctx.lineTo(rx,ry); ctx.stroke();
      });
      ctx.setLineDash([]);
      ctx.fillStyle = '#888';
      [[-50,20],[50,20],[-40,60],[40,60],[-38,28],[38,28]].forEach(([rx,ry])=>{
        ctx.fillRect(rx-2,ry-2,4,4);
      });
      ctx.restore();

      const chairDist = 38;
      ctx.save();
      ctx.translate(Math.cos(backRad)*chairDist, Math.sin(backRad)*chairDist);
      ctx.rotate(anglerRot);
      ctx.strokeStyle = '#555'; ctx.lineWidth = 2;
      [[-10,-6],[10,-6],[-10,6],[10,6]].forEach(([lx,ly])=>{
        ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(lx,ly+14); ctx.stroke();
      });
      ctx.fillStyle = '#6a8060';
      ctx.beginPath(); ctx.roundRect(-12,-8,24,12,3); ctx.fill();
      ctx.strokeStyle = '#4a5a40'; ctx.lineWidth = 1.5; ctx.stroke();
      ctx.restore();

      const anglerDist = 20;
      ctx.save();
      ctx.translate(Math.cos(backRad)*anglerDist, Math.sin(backRad)*anglerDist);
      ctx.rotate(anglerRot);
      ctx.strokeStyle = '#3a5a3a'; ctx.lineWidth = 5; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(-5,0); ctx.lineTo(-8,14); ctx.lineTo(-5,24); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(5,0); ctx.lineTo(8,14); ctx.lineTo(5,24); ctx.stroke();
      ctx.beginPath(); ctx.ellipse(0,-5,9,13,0,0,Math.PI*2);
      const jg = ctx.createLinearGradient(-9,-18,9,8);
      jg.addColorStop(0,'#4a7a3a'); jg.addColorStop(1,'#2d5224');
      ctx.fillStyle = jg; ctx.fill();
      ctx.beginPath(); ctx.ellipse(0,-12,5,4,0,0,Math.PI*2);
      ctx.fillStyle = '#e88020'; ctx.fill();
      ctx.strokeStyle = '#4a7a3a'; ctx.lineWidth = 4;
      ctx.beginPath(); ctx.moveTo(-9,-8); ctx.lineTo(-14,2); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(9,-8); ctx.lineTo(16,-22); ctx.stroke();
      ctx.fillStyle = '#d4a070';
      ctx.beginPath(); ctx.arc(-14,2,3,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(16,-22,3,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(0,-22,7,0,Math.PI*2);
      ctx.fillStyle = '#d4a070'; ctx.fill();
      ctx.fillStyle = '#1a1a3a';
      ctx.beginPath(); ctx.ellipse(-2.5,-23,2.5,1.5,-0.2,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(2.5,-23,2.5,1.5,0.2,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = '#8B6914';
      ctx.beginPath(); ctx.ellipse(0,-28,12,4,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(0,-31,7,5,0,0,Math.PI*2);
      ctx.fillStyle = '#6B4A10'; ctx.fill();
      ctx.beginPath(); ctx.ellipse(0,-28,7,2,0,0,Math.PI*2);
      ctx.fillStyle = '#4a8a4a'; ctx.fill();
      ctx.restore();

      const aWX = Math.cos(backRad)*anglerDist;
      const aWY = Math.sin(backRad)*anglerDist;
      const perpRad = faceRad;
      const rodButX = aWX + Math.cos(perpRad + Math.PI/2)*14 + Math.cos(faceRad)*-8;
      const rodButY = aWY + Math.sin(perpRad + Math.PI/2)*14 + Math.sin(faceRad)*-8;
      const rodTipX = rodButX + Math.cos(faceRad)*80;
      const rodTipY = rodButY + Math.sin(faceRad)*80;
      ctx.save();
      ctx.strokeStyle = '#8B5E2A'; ctx.lineWidth = 3; ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(rodButX, rodButY);
      ctx.quadraticCurveTo(
        rodButX + Math.cos(faceRad)*35 + Math.sin(faceRad)*-12,
        rodButY + Math.sin(faceRad)*35 + Math.cos(faceRad)*12,
        rodTipX, rodTipY
      );
      ctx.stroke();
      ctx.strokeStyle = '#c8a860'; ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(rodButX + Math.cos(faceRad)*50, rodButY + Math.sin(faceRad)*50);
      ctx.lineTo(rodTipX, rodTipY);
      ctx.stroke();
      ctx.fillStyle = '#888';
      ctx.beginPath();
      ctx.arc(rodButX + Math.cos(faceRad)*12, rodButY + Math.sin(faceRad)*12, 4, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();

      ctx.restore();
    }
  });
}

function drawFloat() {
  if(!floatPos)return;
  const peg=pegs.find(p=>p.id===selectedPeg); if(!peg)return;
  const sink=castSinking?sinkProgress:1,fx=floatPos.x+bobDriftX,fy=floatPos.y+bobDriftY,bobOff=Math.sin(bobPhase)*3*sink;
  const tc=gameState==='fish-hooked'?(tension>75?'#f04545':tension>45?'#f07830':'#f0c040'):'rgba(200,180,120,0.7)';
  const lw=gameState==='fish-hooked'?Math.max(1.2,tension*0.035):1.2;
  ctx.save();ctx.strokeStyle=tc;ctx.lineWidth=lw;ctx.setLineDash([]);
  if(gameState==='fish-hooked'&&tension>50){const vx=tension>70?(Math.random()-0.5)*(tension-60)*0.08:0,vy=tension>70?(Math.random()-0.5)*(tension-60)*0.08:0;ctx.beginPath();ctx.moveTo(peg.x,peg.y);ctx.lineTo(fx+vx,fy+bobOff+vy);ctx.stroke();}
  else{const mx=(peg.x+fx)/2+(fy-peg.y)*0.1,my=(peg.y+fy)/2+(peg.x-fx)*0.05;ctx.beginPath();ctx.moveTo(peg.x,peg.y);ctx.quadraticCurveTo(mx,my,fx,fy+bobOff);ctx.stroke();}
  ctx.restore();
  if(castSinking){ctx.save();ctx.globalAlpha=1-sinkProgress;ctx.beginPath();ctx.arc(fx,fy,20,0,Math.PI*2);ctx.strokeStyle='#4fc3f7';ctx.lineWidth=2;ctx.stroke();ctx.restore();}
  const fa=Math.min(1,sinkProgress*3);ctx.save();ctx.globalAlpha=fa;
  const ni=getNightFactor()>0.3;
  if(ni){ctx.shadowColor='#00ff88';ctx.shadowBlur=18;ctx.strokeStyle='#00ff88';}else{ctx.strokeStyle='#f5f5f5';ctx.shadowBlur=0;}
  ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(fx,fy+bobOff-22);ctx.lineTo(fx,fy+bobOff-6);ctx.stroke();
  ctx.beginPath();ctx.arc(fx,fy+bobOff-22,3,0,Math.PI*2);
  if(ni){ctx.fillStyle='#00ff88';ctx.shadowColor='#00ff88';ctx.shadowBlur=22;}else{ctx.fillStyle=gameState==='fish-hooked'?'#f04545':'#ff5252';ctx.shadowBlur=0;}
  ctx.fill();ctx.shadowBlur=0;
  ctx.beginPath();ctx.ellipse(fx,fy+bobOff,6,16,0,0,Math.PI*2);
  const fg=ctx.createLinearGradient(fx-6,fy+bobOff-16,fx+6,fy+bobOff+16);
  if(ni){fg.addColorStop(0,'#00cc66');fg.addColorStop(0.5,'#ffffff');fg.addColorStop(1,'#00cc66');ctx.shadowColor='#00ff88';ctx.shadowBlur=14;}
  else{fg.addColorStop(0,'#ff5252');fg.addColorStop(0.5,'#ffffff');fg.addColorStop(1,'#ff5252');}
  ctx.fillStyle=fg;ctx.fill();ctx.shadowBlur=0;ctx.strokeStyle='rgba(0,0,0,0.3)';ctx.lineWidth=1;ctx.stroke();
  if(gameState==='fish-hooked'&&fishRunning){ctx.beginPath();ctx.arc(fx,fy+bobOff,12,0,Math.PI*2);ctx.strokeStyle=`rgba(240,69,69,${0.3+0.3*Math.sin(bobPhase*8)})`;ctx.lineWidth=2;ctx.stroke();}
  ctx.restore();
  if(sink>0.5){ctx.save();ctx.globalAlpha=0.3*fa;ctx.strokeStyle='#b0bec5';ctx.lineWidth=1;ctx.setLineDash([3,4]);ctx.beginPath();ctx.moveTo(fx,fy+bobOff+16);ctx.lineTo(fx,fy+bobOff+16+floatDepth*30);ctx.stroke();ctx.setLineDash([]);ctx.restore();}
  if(selectedBait&&sink>0.8){ctx.save();ctx.globalAlpha=0.6*fa;ctx.font='14px Arial';ctx.fillText(selectedBait.icon,fx-7,fy+bobOff+20+floatDepth*30);ctx.restore();}
  if(gameState==='fishing'&&sink>=1&&!isReelIn){ctx.save();ctx.globalAlpha=0.55+0.2*Math.sin(bobPhase*2);ctx.fillStyle='rgba(0,0,0,0.55)';ctx.beginPath();ctx.roundRect(fx-58,fy-46,116,18,4);ctx.fill();ctx.fillStyle='#a0e0ff';ctx.font='bold 9px Nunito,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('HOLD SCREEN TO REEL IN',fx,fy-37);ctx.textAlign='left';ctx.textBaseline='alphabetic';ctx.restore();}
}

function drawAimingArc() {
  if(gameState!=='aiming'&&gameState!=='power')return;
  const peg=pegs.find(p=>p.id===selectedPeg);if(!peg)return;
  const faceAngle=pegFacingAngle(peg),sweepRad=(faceAngle+angleSweep)*Math.PI/180,faceRad=faceAngle*Math.PI/180,spanRad=70*Math.PI/180,maxDist=800,aimDist=gameState==='power'?((powerLevel/100)*750+50):maxDist*0.8;
  ctx.save();
  ctx.beginPath();ctx.moveTo(peg.x,peg.y);ctx.arc(peg.x,peg.y,maxDist,faceRad-spanRad,faceRad+spanRad);ctx.closePath();ctx.fillStyle='rgba(255,215,0,0.07)';ctx.fill();ctx.strokeStyle='rgba(255,215,0,0.25)';ctx.lineWidth=2;ctx.stroke();
  ctx.setLineDash([10,14]);ctx.lineWidth=1.5;[0.33,0.66,1.0].forEach((f,i)=>{ctx.beginPath();ctx.arc(peg.x,peg.y,f*maxDist,faceRad-spanRad,faceRad+spanRad);ctx.strokeStyle=`rgba(255,215,0,${0.12+i*0.06})`;ctx.stroke();});ctx.setLineDash([]);
  const tx=peg.x+Math.cos(sweepRad)*aimDist,ty=peg.y+Math.sin(sweepRad)*aimDist;
  ctx.strokeStyle='rgba(255,200,0,0.25)';ctx.lineWidth=14;ctx.beginPath();ctx.moveTo(peg.x,peg.y);ctx.lineTo(tx,ty);ctx.stroke();
  ctx.strokeStyle='rgba(255,230,50,0.5)';ctx.lineWidth=6;ctx.beginPath();ctx.moveTo(peg.x,peg.y);ctx.lineTo(tx,ty);ctx.stroke();
  ctx.strokeStyle='#ffe040';ctx.lineWidth=2.5;ctx.setLineDash([16,8]);ctx.beginPath();ctx.moveTo(peg.x,peg.y);ctx.lineTo(tx,ty);ctx.stroke();ctx.setLineDash([]);
  const pulse=0.5+0.5*Math.sin(bobPhase*4),crossR=16+pulse*6;
  ctx.beginPath();ctx.arc(tx,ty,crossR+6,0,Math.PI*2);ctx.strokeStyle=`rgba(255,200,0,${0.2+pulse*0.2})`;ctx.lineWidth=4;ctx.stroke();
  ctx.beginPath();ctx.arc(tx,ty,crossR,0,Math.PI*2);ctx.strokeStyle='#ffe040';ctx.lineWidth=2.5;ctx.stroke();
  const cLen=crossR*0.6;ctx.strokeStyle='#ffe040';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(tx-crossR-cLen,ty);ctx.lineTo(tx-crossR+4,ty);ctx.moveTo(tx+crossR-4,ty);ctx.lineTo(tx+crossR+cLen,ty);ctx.moveTo(tx,ty-crossR-cLen);ctx.lineTo(tx,ty-crossR+4);ctx.moveTo(tx,ty+crossR-4);ctx.lineTo(tx,ty+crossR+cLen);ctx.stroke();
  ctx.beginPath();ctx.arc(tx,ty,4,0,Math.PI*2);ctx.fillStyle='#ffe040';ctx.fill();
  if(gameState==='power'){
    const bX=peg.x-60,bY=peg.y-130,bW=120,bH=20;
    ctx.save();ctx.fillStyle='rgba(14,26,15,0.85)';ctx.beginPath();ctx.roundRect(bX-10,bY-30,bW+20,bH+42,10);ctx.fill();ctx.strokeStyle='rgba(255,224,64,0.4)';ctx.lineWidth=1.5;ctx.stroke();
    ctx.fillStyle='#ffe040';ctx.font='bold 11px Nunito,sans-serif';ctx.textAlign='center';ctx.fillText('‚ö° TAP TO RELEASE',bX+bW/2,bY-10);
    ctx.fillStyle='#0a120a';ctx.beginPath();ctx.roundRect(bX,bY,bW,bH,6);ctx.fill();
    const fw=(powerLevel/100)*bW,pc=powerLevel<40?'#6ddb4a':powerLevel<75?'#f0c040':'#f04545';
    ctx.fillStyle=pc;ctx.beginPath();ctx.roundRect(bX,bY,fw,bH,6);ctx.fill();
    ctx.fillStyle='#fff';ctx.font='bold 12px Nunito,sans-serif';ctx.fillText(Math.round(powerLevel)+'%',bX+bW/2,bY+bH-4);ctx.textAlign='left';ctx.restore();
  }
  ctx.restore();
}

function drawFightOverlay() {
  if(gameState!=='fish-hooked'||!hookedFish)return;
  const vp=document.getElementById('viewport'),vpCX=(vp.clientWidth/2-viewX)/viewScale,vpCY=(vp.clientHeight/2-viewY)/viewScale,vpHh=vp.clientHeight/2/viewScale;
  ctx.save();

  // Slim pulsing status strip at top of viewport (keeps the in-world feel)
  const bY=vpCY-vpHh+22,bX=vpCX;
  const dangerRun = fishRunning && isReeling;
  const alpha = 0.55 + 0.25*Math.sin(bobPhase*6);
  let bC, bT;
  if(dangerRun){
    bC=`rgba(180,20,20,${alpha})`;
    bT='‚ö†Ô∏è RUNNING ‚Äî RELEASE REEL!';
  } else if(fishRunning){
    bC='rgba(100,10,10,0.65)';
    bT='üèÉ FISH RUNNING';
  } else if(isReeling){
    bC= sweetSpotInZone ? 'rgba(15,110,15,0.75)' : 'rgba(10,70,10,0.65)';
    bT= sweetSpotInZone ? '‚≠ê SWEET SPOT!' : 'üîÑ REELING IN';
  } else {
    bC='rgba(14,36,14,0.55)';
    bT='üí§ RESTING';
  }
  ctx.fillStyle=bC; ctx.beginPath(); ctx.roundRect(bX-130,bY-12,260,26,5); ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font='bold 11px Nunito,sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(bT,bX,bY);

  // Fishing line from peg to fish ‚Äî color/thickness reflects tension
  const peg=pegs.find(p=>p.id===selectedPeg);
  if(peg && floatPos){
    const reel=getActiveReel(), tensionNorm=(tension/reel.tensionMax)*100;
    const lineAlpha = 0.5 + tensionNorm*0.004;
    const lineW = 1.5 + tensionNorm*0.025;
    // Line colour: green ‚Üí orange ‚Üí red
    const lR = tensionNorm<45 ? Math.round(tensionNorm/45*100) : 255;
    const lG = tensionNorm>75 ? Math.round((100-tensionNorm)/25*200) : 200;
    ctx.strokeStyle=`rgba(${lR},${lG},30,${lineAlpha})`;
    ctx.lineWidth = lineW;
    ctx.setLineDash([]);
    ctx.beginPath(); ctx.moveTo(peg.x,peg.y); ctx.lineTo(floatPos.x,floatPos.y); ctx.stroke();

    // Tension vibration effect on high strain
    if(tensionNorm > 70){
      const vib = (tensionNorm-70)/30;
      const midX=(peg.x+floatPos.x)/2+Math.sin(bobPhase*18)*vib*12;
      const midY=(peg.y+floatPos.y)/2+Math.cos(bobPhase*18)*vib*12;
      ctx.globalAlpha = vib*0.5; ctx.strokeStyle='rgba(240,80,30,0.8)';
      ctx.lineWidth=lineW*1.8; ctx.beginPath(); ctx.moveTo(peg.x,peg.y); ctx.quadraticCurveTo(midX,midY,floatPos.x,floatPos.y); ctx.stroke();
      ctx.globalAlpha = 1;
    }
  }

  ctx.textAlign='left';ctx.textBaseline='alphabetic';ctx.restore();
}

const STARS=Array.from({length:160},()=>({x:Math.random()*WORLD_W,y:Math.random()*WORLD_H*0.6,r:0.5+Math.random()*1.5,twinkle:Math.random()*Math.PI*2}));
let starPhase=0;
function drawStars(nf){starPhase+=0.02;ctx.save();STARS.forEach(s=>{ctx.globalAlpha=nf*(0.4+0.4*Math.sin(starPhase+s.twinkle));ctx.fillStyle='#ffffff';ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();});ctx.restore();}

function drawTimeHUD(){
  const wx=(16-viewX)/viewScale, wy=(16-viewY)/viewScale;
  const timeStr=getGameTimeStr();
  const phase=getDayPhase();
  const icons={night:'üåô',dawn:'üåÖ',day:'‚òÄÔ∏è',dusk:'üåá'};
  const phaseLabel=(icons[phase]||'‚òÄÔ∏è')+' '+phase.toUpperCase();
  ctx.save();
  ctx.globalAlpha=0.92;
  // Background box
  ctx.fillStyle='rgba(0,0,0,0.68)';
  ctx.beginPath();ctx.roundRect(wx,wy,120,44,10);ctx.fill();
  // Time digits ‚Äî large, top-aligned
  ctx.font='bold 24px "Black Han Sans",sans-serif';
  ctx.fillStyle='#ffffff';
  ctx.textAlign='center';
  ctx.textBaseline='top';
  ctx.fillText(timeStr, wx+60, wy+5);
  // Phase label ‚Äî small, below the time
  ctx.font='bold 10px Nunito,sans-serif';
  ctx.fillStyle='rgba(255,255,255,0.5)';
  ctx.fillText(phaseLabel, wx+60, wy+31);
  ctx.textAlign='left';ctx.textBaseline='alphabetic';
  ctx.restore();
}

function drawRipples(){ripples.forEach(r=>{ctx.save();ctx.globalAlpha=r.alpha;ctx.strokeStyle='rgba(150,220,255,0.8)';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(r.x,r.y,r.r,0,Math.PI*2);ctx.stroke();ctx.restore();});}

function drawCarpBubbles(){
  if(carpBubbles.length===0)return;
  ctx.save();
  carpBubbles.forEach(b=>{
    ctx.globalAlpha=b.alpha*0.65;
    ctx.strokeStyle='rgba(180,230,255,0.9)';
    ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.stroke();
    ctx.globalAlpha=b.alpha*0.18;
    ctx.fillStyle='rgba(220,245,255,1)';
    ctx.beginPath();ctx.arc(b.x-b.r*0.3,b.y-b.r*0.3,b.r*0.35,0,Math.PI*2);ctx.fill();
  });
  ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    r=Math.min(r,w/2,h/2);this.beginPath();this.moveTo(x+r,y);this.arcTo(x+w,y,x+w,y+h,r);this.arcTo(x+w,y+h,x,y+h,r);this.arcTo(x,y+h,x,y,r);this.arcTo(x,y,x+w,y,r);this.closePath();return this;
  };
}
window.addEventListener('load',init);
window.addEventListener('resize',()=>{if(gameState!=='aquarium')resetView();if(gameState==='aquarium')aqResize();});
</script>
</body>
</html>
